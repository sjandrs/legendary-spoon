<!-- AUTO-GENERATED: Do not edit this file directly. -->
---
title: Converge CRM — Compiled Specification
version: 1.0
generated_at: 2025-10-12T01:35:02.131230+00:00
source_priority: [main.md, spec/spec-design-master.md, spec/*.md]
---

# Compiled Specification
This document aggregates the master spec (main.md) and module specs under `spec/`.

## Contents
- [1. main.md](main.md)
- [2. spec/spec-design-master.md](spec/spec-design-master.md)
- [3. spec/design.md](spec/design.md)
- [4. spec/requirements.md](spec/requirements.md)
- [5. spec/spec-design-accounting-expansion.md](spec/spec-design-accounting-expansion.md)
- [6. spec/spec-design-accounting-expansion[processed].md](spec/spec-design-accounting-expansion[processed].md)
- [7. spec/spec-design-field-service-management.md](spec/spec-design-field-service-management.md)
- [8. spec/spec-lineup-cannon-features-25.md](spec/spec-lineup-cannon-features-25.md)
- [9. spec/spec-lineup-cannon-features-5.md](spec/spec-lineup-cannon-features-5.md)
- [10. spec/spec-process-lint-baseline-gating.md](spec/spec-process-lint-baseline-gating.md)
- [11. spec/spec-process-lint-baseline-gating[processed].md](spec/spec-process-lint-baseline-gating[processed].md)
- [12. spec/tasks.md](spec/tasks.md)

---



## 1. Source: main.md

# Converge CRM – Master Specification (AI coding agent)

This file serves as the top-level, living specification for Converge CRM when working with AI coding agents. It complements the detailed specs in `spec/` and user-facing docs in `README.md` and `docs/`.

## Sources of Truth

- User-facing docs: `README.md`, `docs/`
- Detailed specifications: `spec/` (compiled via `tools/spec_compile.py` into `spec/COMPILED_SPEC.md`)
- Primary detailed spec: `spec/spec-design-master.md` (PRIORITY for implementation details)
- Repository instructions: `.github/copilot-instructions.md`

## Architecture Summary

- Backend: Django + Django REST Framework in `main/`
- Frontend: React + Vite in `frontend/`
- Auth: Custom token authentication (`main/api_auth_views.py`)
- Data model: CRM, Accounting, Workflow, Field Service; see `main/models.py`

## Development Rules

1. Follow established patterns:
   - DRF ModelViewSet + serializers + permissions
   - Role-based access (Sales Rep vs Sales Manager)
   - Activity logging on create/update
2. Update tests with any behavior change; keep tests green
3. Prefer incremental, small PRs
4. Keep documentation and specs in sync

## Implementation Focus

When extending functionality, prioritize:

- Backend models/APIs per `spec/*`
- Frontend components and navigation wiring
- Business workflows in `main/signals.py` and related services

## Build and Quality

- Use VS Code tasks to run tests and linters
- CI must pass: Spec Validation, Spec Compile, Spec Pages, Spec Release



## 2. Source: spec/spec-design-master.md

---
title: Converge CRM Master Design Specification
version: 1.0
date_created: 2025-10-09
last_updated: 2025-10-11
owner: Converge Product Team
tags: [design, architecture, master, backend, frontend]
---

# Introduction {#intro}

This document is the master design specification for the Converge CRM platform. It serves as the authoritative source of truth for all backend and frontend development, defining the architecture, requirements, and interfaces for all system components.

## 1. Purpose & Scope

This specification provides a comprehensive guide for developers, architects, and product managers involved in the development of the Converge CRM. It covers the entire system, from the Django backend to the React frontend, ensuring consistency and adherence to established patterns.

## 2. Definitions

- **CRM**: Customer Relationship Management
- **DRF**: Django REST Framework
- **SPA**: Single Page Application
- **RBAC**: Role-Based Access Control
- **WCAG**: Web Content Accessibility Guidelines

## 3. Requirements, Constraints & Guidelines {#requirements}

### System-Wide Requirements
- **REQ-SYS-001**: All features MUST align with the user stories documented in static/kb/user-stories.md.
- **REQ-SYS-002**: The system MUST enforce strict Role-Based Access Control (RBAC) for all data and features.
- **REQ-SYS-003**: All API endpoints MUST follow RESTful principles and maintain a consistent structure.
- **REQ-SYS-004**: Every significant CRM operation MUST be logged in the ActivityLog for auditing purposes.
- **REQ-SYS-005**: The frontend MUST be fully responsive and comply with WCAG 2.1 AA accessibility standards.
- **REQ-SYS-006**: Resolving any GitHub issue MUST include updating relevant specifications in `spec/` (master or module-specific) to reflect behavior, constraints, and any new operational rules.

### Backend Constraints
- **CON-BE-001**: The backend MUST be a pure API server built with Django and Django REST Framework.
- **CON-BE-002**: Authentication MUST use a custom token-based system, not Django's default session authentication.
- **CON-BE-003**: The database MUST be SQLite in development and PostgreSQL in production.

### Frontend Constraints
- **CON-FE-001**: The frontend MUST be a Single Page Application (SPA) built with React and Vite.
- **CON-FE-002**: State management SHOULD primarily use React Hooks and TanStack Query.
- **CON-FE-003**: All API interactions MUST be handled through a centralized Axios client.
 - **CON-FE-004**: Lint baseline reports MUST include "Quality Gate Result" and "Invocation Parameters" sections for CI traceability.

### User Stories Framework {#user-stories}
- Coverage: 130+ user stories covering all platform capabilities across CRM, Accounting, Workflow, Analytics, Technician Ops, and Infrastructure.
- Source of Truth: static/kb/user-stories.md (complete user story framework that drives development and testing).
- Implementation Status: Phase 1–4 backend user stories implemented and tested; 23/23 tests passing as of 2025-10-10.

Development workflow mapping
- REQ-US-001: Every feature change MUST reference an existing user story or add a new one with business justification.
- REQ-US-002: User stories MUST map to RESTful endpoints defined in main/api_views.py.
- REQ-US-003: Acceptance criteria from user stories MUST translate to automated tests in main/tests.py (or module-specific tests).
- REQ-US-004: Frontend components MUST implement user story behavior and error handling patterns.
- REQ-US-005: Each story SHALL include measurable outcomes enabling stakeholder validation.

User story categories (canonical ranges)
- CRM Core (CRM-001→CRM-015): Account management, contact tracking, deal pipeline, interaction logging.
- Financial Management (ALM-001→EPP-010): Ledger, journal automation, work orders, payment processing.
- Workflow Automation: Time tracking, inventory management, project templates, automated workflows.
- Analytics & AI (PAI-001→PAI-015): Predictive analytics, CLV intelligence, revenue forecasting, BI.
- Technician Operations (ETO-001→ETO-015): Certifications, coverage areas, availability, compliance.
- Infrastructure (NTF-001→SLM-010): Notifications, security, logging, content management.

Guidance
- PAT-US-001: All code changes SHALL align with user stories in static/kb/user-stories.md and this master spec.
- PAT-US-002: When a new story is introduced, update static/kb/user-stories.md and link here under the appropriate category.
- PAT-US-003: Keep acceptance criteria atomic and testable (Given/When/Then preferred); ensure API/doc updates accompany behavior changes.

## Architecture & Domain Model Overview {#architecture}

### Platform Architecture
- Backend: Django 5 + Django REST Framework, custom token authentication (`main/api_auth_views.py`).
- Frontend: React + Vite SPA with centralized Axios client (`frontend/src/api.js`).
- Database: SQLite in development, PostgreSQL in production. Custom `CustomUser` model extends `AbstractUser`.
Minimal core graph for Work Order Service Management, aligned to implementation in `main/models.py` and industry models.

```python
# Customer context
Account 1:N Contact

# Execution context
Project -> Account, Contact
WorkOrder -> Project

# Work contents and scheduling
LineItem -> WorkOrder
ScheduledEvent -> WorkOrder, Technician

# Technician constraints and qualifications
TechnicianAvailability -> Technician
CoverageArea -> Technician
TechnicianCertification -> Technician, Certification
WorkOrderCertificationRequirement -> WorkOrder, Certification

# Inventory and billing
InventoryReservation -> ScheduledEvent, WarehouseItem
WorkOrderInvoice -> WorkOrder
Payment -> WorkOrderInvoice  # simplified view; payment may be polymorphic in code

# Communications and approvals
NotificationLog -> (WorkOrder | ScheduledEvent)  # generic link
DigitalSignature -> (WorkOrder) [via PaperworkTemplate optional]
# Supporting
TimeEntry -> Project
```

#### Work Order Lifecycle (high-level)
1) Create WorkOrder (via cases/agreements/deals) with parts/services (LineItem) and customer context (Account/Contact via Project)
2) Schedule and assign (ScheduledEvent → Technician) using availability, coverage, and certification constraints
3) Execute work; capture signatures and send notifications; consume reserved inventory
4) Complete and bill (generate WorkOrderInvoice, accept Payment); update analytics

#### Minimal ER Diagram {#er-diagram}
```mermaid
erDiagram
  ACCOUNT ||--o{ CONTACT : has
  PROJECT }o--|| ACCOUNT : belongs_to
  PROJECT }o--|| CONTACT : primary_contact
  WORK_ORDER }o--|| PROJECT : belongs_to

  WORK_ORDER ||--o{ LINE_ITEM : includes

  SCHEDULED_EVENT }o--|| WORK_ORDER : scheduled_for
  SCHEDULED_EVENT }o--|| TECHNICIAN : assigned_to

  TECHNICIAN ||--o{ TECHNICIAN_AVAILABILITY : has
  TECHNICIAN ||--o{ COVERAGE_AREA : covers

  CERTIFICATION ||--o{ TECHNICIAN_CERTIFICATION : grants
  TECHNICIAN ||--o{ TECHNICIAN_CERTIFICATION : holds
  WORK_ORDER ||--o{ WORK_ORDER_CERT_REQ : requires
  CERTIFICATION ||--o{ WORK_ORDER_CERT_REQ : is_required

  SCHEDULED_EVENT ||--o{ INVENTORY_RESERVATION : reserves
  WAREHOUSE_ITEM ||--o{ INVENTORY_RESERVATION : allocated

  WORK_ORDER ||--o{ WORK_ORDER_INVOICE : billed_as
  WORK_ORDER_INVOICE ||--o{ PAYMENT : paid_by

  WORK_ORDER ||..o{ NOTIFICATION_LOG : notifies
  WORK_ORDER ||..o{ DIGITAL_SIGNATURE : approves
  PAPERWORK_TEMPLATE ||..o{ DIGITAL_SIGNATURE : based_on
```

### Integrated Domain Layers (CRM → FSM → Accounting) {#integrated-domain}

This section aligns the platform model to the optimum integrated pattern defined in research, ensuring seamless quote→order→delivery→invoice→payment→posting flow.

1) CRM backbone (sell-to-cash initiation)
  - Account 1:N Contact
  - Account 1:N Deal (Opportunity)
  - Deal 1:1 Quote; Quote 1:N QuoteItem
  - Deal 1:N Invoice; Invoice 1:N InvoiceItem; Payment → Invoice

2) Field Service (service delivery execution)
  - Project → Account, Contact, Deal (optional)
  - WorkOrder → Project; WorkOrder 1:N LineItem (parts/services)
  - ScheduledEvent → WorkOrder, Technician (recurrence supported)
  - Technician → Availability, CoverageArea; Technician ↔ Certification via TechnicianCertification
  - WorkOrder ↔ Certification via WorkOrderCertificationRequirement
  - InventoryReservation → ScheduledEvent, WarehouseItem (reserve/consume on completion)
  - DigitalSignature → WorkOrder (via PaperworkTemplate); NotificationLog generic to WO/events

3) Bookkeeping (recognize and post)
  - LedgerAccount (Chart of Accounts)
  - JournalEntry (double-entry with debit_account and credit_account)
  - Event-driven postings: invoice posting, payment receipt, inventory consumption

#### Integration Points (optimum) {#integration-points}
- Quote → Deal conversion may drive WorkOrder or Project creation when accepted
- WorkOrderInvoice aggregates WorkOrder parts/labor; Invoices visible in CRM and posted to GL
- Payments settle Invoices and update AR; journal postings are automatic and idempotent
- Inventory reservations originate from scheduling; consumed on completion; GL reflects COGS/Inventory movement
- Technician TimeEntry can roll into labor lines or payroll exports; analytics aggregates KPIs

#### Integrated ER Diagram {#er-diagram-integrated}
```mermaid
erDiagram
  ACCOUNT ||--o{ CONTACT : has
  ACCOUNT ||--o{ DEAL : opportunities
  DEAL ||--|| QUOTE : primary
  QUOTE ||--o{ QUOTE_ITEM : lines
  DEAL ||--o{ INVOICE : bills
  INVOICE ||--o{ INVOICE_ITEM : lines
  INVOICE ||--o{ PAYMENT : settles

  PROJECT }o--|| ACCOUNT : belongs_to
  PROJECT }o--|| CONTACT : primary
  PROJECT }o--o{ DEAL : optional_link
  WORK_ORDER }o--|| PROJECT : belongs_to
  WORK_ORDER ||--o{ LINE_ITEM : includes
  SCHEDULED_EVENT }o--|| WORK_ORDER : scheduled_for
  SCHEDULED_EVENT }o--|| TECHNICIAN : assigned_to
  TECHNICIAN ||--o{ TECHNICIAN_AVAILABILITY : has
  TECHNICIAN ||--o{ COVERAGE_AREA : covers
  TECHNICIAN ||--o{ TECHNICIAN_CERTIFICATION : holds
  CERTIFICATION ||--o{ TECHNICIAN_CERTIFICATION : grants
  WORK_ORDER ||--o{ WORK_ORDER_CERT_REQ : requires
  CERTIFICATION ||--o{ WORK_ORDER_CERT_REQ : is_required
  SCHEDULED_EVENT ||--o{ INVENTORY_RESERVATION : reserves
  WAREHOUSE_ITEM ||--o{ INVENTORY_RESERVATION : allocated
  WORK_ORDER ||..o{ DIGITAL_SIGNATURE : approves
  PAPERWORK_TEMPLATE ||..o{ DIGITAL_SIGNATURE : based_on
  WORK_ORDER ||..o{ NOTIFICATION_LOG : notifies

  LEDGER_ACCOUNT ||--o{ JOURNAL_ENTRY : used_by
  JOURNAL_ENTRY ||--|| LEDGER_ACCOUNT : debit_account
  JOURNAL_ENTRY ||--|| LEDGER_ACCOUNT : credit_account
```

### Accounting & Operations Models
```python
LedgerAccount → JournalEntry (debit_account, credit_account)
Expense (submitted_by, approved_by, category)
Budget (category, period_start, period_end)  # Budget v1 summary; see Budget v2 in Accounting Summary
Payment (invoice | work_order_invoice, amount, payment_method)

Warehouse → WarehouseItem (name, sku, quantity, minimum_stock, unit_cost, gtin?)
TimeEntry (project, user, date, hours, billable)
```

### Custom Field System {#custom-fields}
- Models: `CustomField` defines schema; `CustomFieldValue` stores values using ContentTypes.
- Types: text, number, date, boolean with type-specific columns (`value_text`, `value_number`, `value_date`, `value_boolean`).
- Attach to any model via Generic FK. Example:
```python
CustomField.objects.create(
  name="LinkedIn Profile",
  field_type="text",
  content_type=ContentType.objects.get_for_model(Contact)
)
```
- Frontend integration: serializers expose custom field values; dynamic forms render inputs by type. APIs: `/api/custom-fields/`, `/api/custom-field-values/`.

### API Architecture Patterns {#api-patterns}
- REST convention:
```
GET    /api/{resource}/          # List (pagination + filtering)
POST   /api/{resource}/          # Create
GET    /api/{resource}/{id}/     # Retrieve
PUT    /api/{resource}/{id}/     # Update (full)
PATCH  /api/{resource}/{id}/     # Update (partial)
DELETE /api/{resource}/{id}/     # Delete
```
- ViewSets for all entities; role-based filtering in `get_queryset()` and activity logging in `perform_create`/`perform_update`. See Permission Rules and Activity Logging sections below for canonical snippets.

### Project Conventions {#project-conventions}
- Standards referenced: spec sections {#architecture}, {#api-patterns}, {#field-service-api}, {#tech-user-api}, {#accounting-workflow-summary}
- Instructions followed: Use repository models and endpoints as the primary source of truth; validate patterns against external vendor models (Dynamics 365 Field Service/Sales, Xero Accounting) to ensure parity and soundness.

## 4. Interfaces & Data Contracts {#interfaces}

### Backend API Specification

# Converge CRM - API Specification

Django REST Framework API specification for all backend endpoints.

### API and Schema Documentation (concise index) {#api-index}
- CRM: `/api/accounts/`, `/api/contacts/`, `/api/deals/`, `/api/quotes/`, `/api/quote-items/`, `/api/invoices/`, `/api/invoice-items/`, `/api/payments/`
- FSM: `/api/work-orders/`, `/api/line-items/`, `/api/scheduled-events/`, `/api/technicians/`, `/api/certifications/`, `/api/technician-availability/`, `/api/coverage-areas/`, `/api/inventory-reservations/`, notifications, signatures
- Accounting: `/api/ledger-accounts/`, `/api/journal-entries/`, reports endpoints

Utilities
- `/api/utils/gtin/check-digit/` — Compute/validate GTIN-8/12/13/14 check-digit.
- `/api/utils/gtin/check-digit/` — Compute/validate GTIN-8/12/13/14 check-digit.
  - GET: `?gtin_base=<digits>` (7/11/12/13/14). Returns normalized 14-digit GTIN, computed check digit, and validity.
  - POST: `{ "gtin_base": "03600029145" }` (digits-only). Response: `{ "normalized": "0036000291452", "length": 13, "check_digit": 2, "is_valid": true, "message": "ok" }`.
  - Errors: 400 on non-digits or unsupported length; 400 when `length==14` but check digit invalid.
 - `/api/dev/validate-json/` — Dev-only JSON Schema validator (DEBUG only). Validate a payload against a catalog schema key; returns `{valid, errors[], schema_path}`. See docs/API.md → “Schema usage (JSON Schema)”.
### JSON Schema Catalog {#json-schema-catalog}
Baseline enforcement uses JSON Schema draft-07; 2019-09 and 2020-12 variants are informational only.

- Accounting
  - JournalEntry
    - draft-07: `../../.copilot-tracking/research/20251011-journalentry.schema.json`
    - 2019-09: `../../.copilot-tracking/research/20251011-journalentry.schema-2019-09.json`
    - 2020-12: `../../.copilot-tracking/research/20251011-journalentry.schema-2020-12.json`
    - Notes: Aligns with `main.models.JournalEntry`; single-amount double-entry with debit/credit account IDs.
  - Payment
    - draft-07: `../../.copilot-tracking/research/20251011-payment.schema.json`
    - 2019-09: `../../.copilot-tracking/research/20251011-payment.schema-2019-09.json`
    - 2020-12: `../../.copilot-tracking/research/20251011-payment.schema-2020-12.json`
    - Notes: GenericForeignKey target via content_type/object_id (writeOnly); amount >= 0; date formatted.
  - Expense
    - draft-07: `../../.copilot-tracking/research/20251011-expense.schema.json`
    - Notes: Non-breaking annotations; matches spec example; URI ref for receipt.
  - MonthlyDistribution
    - draft-07: `../../.copilot-tracking/research/20251011-monthlydistribution.schema.json`
    - 2019-09: `../../.copilot-tracking/research/20251011-monthlydistribution.schema-2019-09.json`
    - 2020-12: `../../.copilot-tracking/research/20251011-monthlydistribution.schema-2020-12.json`
    - Notes: 12 entries required, each representing a monthly allocation; sum==100% enforced server-side; used by Budget v2.
  - BudgetV2
    - draft-07: `../../.copilot-tracking/research/20251011-budget-v2.schema.json`
    - 2019-09: `../../.copilot-tracking/research/20251011-budget-v2.schema-2019-09.json`
    - 2020-12: `../../.copilot-tracking/research/20251011-budget-v2.schema-2020-12.json`
    - Notes: Requires Cost Center, optional Project; references MonthlyDistribution; totals=100% enforced server-side.

- Field Service Management (FSM)
  - ScheduledEvent
    - draft-07: `../../.copilot-tracking/research/20251011-scheduled-event.schema.json`
    - 2019-09: `../../.copilot-tracking/research/20251011-scheduled-event.schema-2019-09.json`
    - 2020-12: `../../.copilot-tracking/research/20251011-scheduled-event.schema-2020-12.json`
    - Notes: RRULE is a free-form string validated server-side; status enumerations per model.
  - NotificationLog
    - draft-07: `../../.copilot-tracking/research/20251011-notificationlog.schema.json`
    - 2019-09: `../../.copilot-tracking/research/20251011-notificationlog.schema-2019-09.json`
    - 2020-12: `../../.copilot-tracking/research/20251011-notificationlog.schema-2020-12.json`
    - Notes: Channel/status enums; external_id and timestamps readOnly where applicable.

- Staff & Technician
  - Technician
    - draft-07: `../../.copilot-tracking/research/20251011-technician.schema.json`
    - 2019-09: `../../.copilot-tracking/research/20251011-technician.schema-2019-09.json`
    - 2020-12: `../../.copilot-tracking/research/20251011-technician.schema-2020-12.json`
    - Notes: Core profile; nested relations (coverage, certs, availability) via separate endpoints.

- Inventory & Work Orders
  - WarehouseItem
    - draft-07: `../../.copilot-tracking/research/20251011-warehouseitem.schema.json`
    - 2019-09: `../../.copilot-tracking/research/20251011-warehouseitem.schema-2019-09.json`
    - 2020-12: `../../.copilot-tracking/research/20251011-warehouseitem.schema-2020-12.json`
    - Notes: Optional digits-only `gtin` (8/12/13/14) with server-side check-digit validation.
  - WorkOrder
    - draft-07: `../../.copilot-tracking/research/20251011-workorder.schema.json`
    - 2019-09: `../../.copilot-tracking/research/20251011-workorder.schema-2019-09.json`
    - 2020-12: `../../.copilot-tracking/research/20251011-workorder.schema-2020-12.json`
    - Notes: Line items are readOnly; scheduling and invoicing modeled via related resources.
  - WorkOrderInvoice
    - draft-07: `../../.copilot-tracking/research/20251011-workorderinvoice.schema.json`
    - 2019-09: `../../.copilot-tracking/research/20251011-workorderinvoice.schema-2019-09.json`
    - 2020-12: `../../.copilot-tracking/research/20251011-workorderinvoice.schema-2020-12.json`
    - Notes: Payment terms enums; overdue fields are computed readOnly values.

Configuration examples
```json
{
  "posting_rules": {
    "invoice_post": ["DR:AccountsReceivable", "CR:Revenue"],
    "payment_receive": ["DR:Cash", "CR:AccountsReceivable"],
    "inventory_consume": ["DR:COGS", "CR:Inventory"]
  },
  "scheduling": { "rrule_support": true, "optimize_routes": true },
  "qualification": { "enforce_certifications": true }
}
```

Technical requirements
- Enforce double-entry invariants on JournalEntry writes
- Idempotent posting from operational events (invoice post, payment, consumption)
- RBAC across CRM, FSM, and Accounting; audit via ActivityLog and NotificationLog

Recommended approach
- CRM backbone: Account, Contact, Deal, Quote(+Items), Invoice(+Items), Payment
- FSM execution: Project, WorkOrder(+LineItems), ScheduledEvent→Technician, Availability/Coverage, Certifications (+requirements), InventoryReservation, DigitalSignature, NotificationLog
- Bookkeeping core: LedgerAccount (COA), JournalEntry (double-entry)
- Integrations: Event-driven postings; invoice generation from WorkOrders; inventory consumption on completion; payments applied to invoices; analytics snapshots

Schema enforcement and variants
- JSON Schema baseline: draft-07 is authoritative and enforced for API contract validation where applicable.
- Informational variants: 2019-09 and 2020-12 schema files MAY be provided for reference; they are non-enforcing annotations due to validator compatibility.
- CSV artifacts follow RFC 4180 where exported.

Implementation guidance
- Objectives: Unified quote→order→delivery→invoice→payment→posting; accurate inventory and GL in real time
- Key Tasks: Wire posting rules; ensure WorkOrder↔Invoice mapping; enforce assignment constraints; implement reservation→consumption; add acceptance tests for postings
- Dependencies: `main/models.py` for entities; `main/api_urls.py` for endpoints; ActivityLog for audit; RBAC per ViewSets
- Success Criteria: End-to-end flows produce correct GL postings, satisfy scheduling constraints, accurate inventory levels, and traceable communications/approvals

## Authentication API

### Token Authentication
```
POST   /api/auth/login/
Request: {"username": "user@example.com", "password": "password123"}
Response: {"token": "9944b09199c62bcf9418ad846dd0e4bbdfc6ee4b", "user": {...}}

POST   /api/auth/logout/
Headers: Authorization: Token 9944b09199c62bcf9418ad846dd0e4bbdfc6ee4b
Response: {"message": "Successfully logged out"}

GET    /api/auth/user/
Headers: Authorization: Token 9944b09199c62bcf9418ad846dd0e4bbdfc6ee4b
Response: {"id": 1, "username": "user@example.com", "groups": ["Sales Rep"], ...}
```

## CRM Core API

### Accounts API
```
GET    /api/accounts/
Headers: Authorization: Token <token>
Query Params: ?search=<term>&page=<num>&page_size=<size>
Response: {
  "count": 150,
  "next": "http://api/accounts/?page=2",
  "previous": null,
  "results": [
    {
      "id": 1,
      "name": "Acme Corporation",
      "industry": "Technology",
      "annual_revenue": "5000000.00",
      "website": "https://acme.com",
      "phone": "+1-555-0123",
      "address": "123 Business St, City, State 12345",
      "owner": 1,
      "created_at": "2025-01-01T10:00:00Z",
      "updated_at": "2025-01-01T10:00:00Z",
      "contacts_count": 5,
      "deals_count": 3,
      "total_deal_value": "150000.00"
    }
  ]
}

POST   /api/accounts/
Headers: Authorization: Token <token>
Request: {
  "name": "New Account",
  "industry": "Healthcare",
  "annual_revenue": "2500000.00",
  "website": "https://newaccount.com",
  "phone": "+1-555-0456",
  "address": "456 Medical Dr, City, State 12345"
}
Response: 201 Created + account object with generated ID

GET    /api/accounts/{id}/
Headers: Authorization: Token <token>
Response: Account object with related data

PUT    /api/accounts/{id}/
Headers: Authorization: Token <token>
Request: Full account object
Response: 200 OK + updated account object

PATCH  /api/accounts/{id}/
Headers: Authorization: Token <token>
Request: Partial account object
Response: 200 OK + updated account object

DELETE /api/accounts/{id}/
Headers: Authorization: Token <token>
Response: 204 No Content
```

### Contacts API
```
GET    /api/contacts/
Query Params: ?search=<term>&account=<id>&page=<num>
Response: Paginated contact list with account names

POST   /api/contacts/
Request: {
  "account": 1,
  "first_name": "John",
  "last_name": "Smith",
  "email": "john.smith@acme.com",
  "phone": "+1-555-0789",
  "title": "VP of Sales"
}
Response: 201 Created + contact object

GET    /api/contacts/{id}/
Response: Contact object with account details and interaction history

PUT    /api/contacts/{id}/
Request: Full contact object
Response: 200 OK + updated contact

DELETE /api/contacts/{id}/
Response: 204 No Content
```

Notes
- RBAC: Sales Managers can access all contacts; other users may only access contacts where owner == current user.

### Deals API
```
GET    /api/deals/
Query Params: ?stage=<stage>&account=<id>&owner=<id>&page=<num>
Response: Paginated deal list with account/contact names

POST   /api/deals/
Request: {
  "name": "Q4 Software License Deal",
  "account": 1,
  "primary_contact": 1,
  "value": "50000.00",
  "stage": "qualified",
  "probability": 25,
  "close_date": "2025-12-31"
}
Response: 201 Created + deal object

PUT    /api/deals/{id}/
Request: Updated deal object (stage change may trigger Project creation)
Response: 200 OK + updated deal

# Special stage transition behavior:
# When deal.stage changes to 'won', automatically creates Project:
# - Project.name = Deal.name
# - Project.deal = Deal.id
# - Project.status = 'planning'
# - Project.owner = Deal.owner
```

### Quotes API
```
GET    /api/quotes/
Query Params: ?status=<status>&account=<id>&page=<num>
Response: Paginated quote list

POST   /api/quotes/
Request: {
  "name": "Q4 Software Quote",
  "account": 1,
  "contact": 1,
  "valid_until": "2025-11-30",
  "tax_rate": "8.25",
  "notes": "Annual license with support"
}
Response: 201 Created + quote object

POST   /api/quotes/{id}/convert-to-deal/
Request: {}
Response: {"deal_id": 123, "message": "Quote converted to deal successfully"}
Business Rule: Only works when quote.status = 'accepted'
```

### Invoices API (CRM) — Posting endpoints
```
POST   /api/invoices/{id}/post/
Headers: Authorization: Token <token>
Response 201: {"journal_entry_id": 42, "amount": "100.00"}
Response 409: {"detail": "Invoice already posted"}

Notes:
- Posting action creates a JournalEntry per AC-GL-001 (see {#ac-gl}).
- Minimal default COA mapping used if explicit config is not present: DR 1100 AccountsReceivable, CR 4000 Revenue.
- Idempotent: subsequent POST returns 409 without creating duplicate entries.
 - Durable posted state: Invoice persists `posted_journal` (FK → JournalEntry) and `posted_at` (DateTime). On first successful post these fields are set; any subsequent post SHALL return 409 when `posted_journal` is not null. A legacy description-based guard MAY also be present during transition.
```

### Payments API — Allocation
```
POST   /api/payments/{id}/allocate/
Headers: Authorization: Token <token>
Request: { "invoice": 123, "amount": "50.00" }  # or { "work_order_invoice": 55, ... }
Response 201: { "journal_entry_id": 77, "applied_to": "invoice", "target_id": 123, "open_balance": "50.00", "status": "partial" }
Response 400: { "detail": "Amount exceeds open balance" }
Response 409: { "detail": "Payment already allocated" }

Notes:
- Posting action creates a JournalEntry per AC-GL-002: DR 1000 Cash, CR 1100 AccountsReceivable for payment.amount.
- Applies amount to Invoice or WorkOrderInvoice; rejects overpayment; returns remaining open_balance and status (partial|paid).
- Idempotent: allocation is guarded; retry does not double-apply.
```

### Quote Items API
```
GET    /api/quote-items/?quote=<id>
Response: Line items for specific quote

POST   /api/quote-items/
Request: {
  "quote": 1,
  "product_name": "Enterprise Software License",
  "description": "Annual license for 50 users",
  "quantity": 50,
  "unit_price": "200.00",
  "discount_percent": "10.00"
}
Response: 201 Created + calculated line_total
Auto-calculation: line_total = quantity * unit_price * (1 - discount_percent/100)
```

### Interactions API
```
GET    /api/interactions/
Query Params: ?account=<id>&contact=<id>&type=<type>&page=<num>
Response: Paginated interaction list ordered by date desc

POST   /api/interactions/
Request: {
  "account": 1,
  "contact": 1,
  "deal": 1,
  "interaction_type": "call",
  "subject": "Discussion about Q4 requirements",
  "notes": "Customer interested in 50-user license. Follow up next week.",
  "date": "2025-10-07T14:30:00Z"
}
Response: 201 Created + interaction object
```

### Technician & User Management API {#tech-user-api}
Core endpoints for technician lifecycle, certifications, coverage, availability, hierarchical users, and qualification checks.

```
GET    /api/technicians/
POST   /api/technicians/
GET    /api/certifications/
POST   /api/certifications/
GET    /api/technician-certifications/
POST   /api/technician-certifications/
GET    /api/coverage-areas/
POST   /api/coverage-areas/
GET    /api/technician-availability/
POST   /api/technician-availability/
GET    /api/work-order-cert-requirements/
POST   /api/work-order-cert-requirements/

# Assignment & payroll helpers
GET    /api/technicians/available/                      # Filter by date/time/skills via query
POST   /api/work-orders/{id}/find-technicians/         # Match by skills, coverage, availability
POST   /api/work-orders/{id}/assign-technician/        # Assign and log activity
GET    /api/technicians/{id}/payroll/                  # Aggregated time-entry payroll view
```

Notes
- RBAC: Only managers can see/manage all technicians; reps limited to their team.
- Qualification: `WorkOrderCertificationRequirement` enforces required certs on assignment.
- Optimization: Coverage and availability optimizers exposed via endpoints with safe defaults.

### Field Service Management API {#field-service-api}
Scheduling, notifications, paperwork, customer requests, signatures, inventory reservations, and scheduling analytics.

```
# Resource endpoints
GET/POST /api/scheduled-events/
GET/POST /api/notification-logs/
GET/POST /api/paperwork-templates/
GET/POST /api/appointment-requests/
GET/POST /api/digital-signatures/
GET/POST /api/inventory-reservations/
GET/POST /api/scheduling-analytics/

# Specialized scheduling endpoints
POST   /api/scheduling/route-optimization/             # Route and sequence optimization
GET    /api/scheduling/availability-check/             # Real-time tech availability

Availability-check (GET or POST)
```
Params: technician_id (int, required), start_time (ISO 8601), end_time (ISO 8601)
Response: { "is_available": true|false, "conflicts": [ { "id": 12, "start": "2025-10-12T10:00:00Z", "end": "2025-10-12T11:00:00Z" } ], "details": "Within weekly availability window" }
```

# Communications
POST   /api/notifications/send-reminder/               # Appointment reminder
POST   /api/notifications/send-on-way/                 # "On My Way" notification
```

Design notes
- Recurrence: `ScheduledEvent.recurrence_rule` (RRULE) with `parent_event` for instances.
  - Validation posture: Keep client schema enums minimal; validate RRULE strings and state transitions server-side to avoid brittle constraints.
- Notifications: `NotificationLog` captures channel, status, and provider IDs for auditability.
- Paperwork: HTML templates with conditional logic; optional `requires_signature` gating flows.
- Signatures: `DigitalSignature` stores base64 image, IP, UA, and a `document_hash` + `is_valid` for integrity checks.
- Inventory: `InventoryReservation` links `ScheduledEvent` to `WarehouseItem` with statuses reserved→consumed/released.
- Analytics: `SchedulingAnalytics` daily snapshots for utilization and completion KPIs.
 - Consumption: Completing a WorkOrder consumes reserved inventory and triggers GL posting (see {#ac-gl}).

### Work Orders — Completion (Inventory Consumption)
```
POST   /api/work-orders/{id}/complete/
Headers: Authorization: Token <token>
Response 201: { "journal_entry_id": 88, "consumed_cost": "35.00" }
Response 409: { "detail": "Work order already completed" }
Response 409: { "detail": "Insufficient stock for one or more items" }

Notes:
- Consumes reserved inventory items; creates JournalEntry per AC-GL-003: DR 5000 COGS, CR 1200 Inventory for total consumed cost.
- No GL entry if total consumed cost is 0 (e.g., only service lines).
- Idempotent: completion is guarded; re-completion does not double-consume nor re-post.
```

### Accounting & Workflow Expansion Summary {#accounting-workflow-summary}
Key API surfaces and patterns introduced by the expansion roadmap:

- Financial Reports
  - GET `/api/reports/balance-sheet/`
  - GET `/api/reports/pnl/`
  - GET `/api/reports/cash-flow/`
  - Export: PDF and CSV supported at the report layer (server-side generation).
- Expenses & Budgets
  - CRUD `/api/expenses/` with receipt upload and categorization
  - CRUD `/api/budgets/` with variance tracking
  - Tax reporting: GET `/api/tax-reports/` (or `/api/tax-report/`), role-restricted
- Deal→WorkOrder Automation
  - POST `/api/workorders/auto` (or signal-based creation on deal “won”)
  - Event-driven triggers (signals) ensure auditable, idempotent creation
- Project Billing & Inventory
  - POST `/api/billing/time` (log billable hours for invoicing)
  - POST `/api/inventory/adjust` (inventory decrements on fulfillment)
- Communications
  - POST `/api/communications/email` (invoice emails, reminders)

- Posting & Double-Entry
  - POST `/api/invoices/{id}/post/` (invoice posting → DR AR, CR Revenue [+ Tax])
  - Payments create postings → DR Cash/Bank, CR AR (partial payments supported)
  - WorkOrder completion consumption → DR COGS, CR Inventory
  - Invariants: double-entry enforced; idempotent postings; explicit 400/409 errors on validation/conflict
  - See Acceptance: {#ac-gl}

Budget v2 and MonthlyDistribution (summary)
- Purpose: Introduce dimensional budgeting with Cost Center and Project dimensions; separate monthly allocation via `MonthlyDistribution` document.
- Defaults/Migration:
  - Mapping source: DB mapping table with admin UI to map legacy Budget to v2 (dimensioned).
  - Default Cost Center: "General Operations" when not provided.
  - Default Distribution: 12 months × 8.33% each when distribution missing.
- Contracts: Draft-07 schemas `Budget_v2` and `MonthlyDistribution` are authoritative; variants (2019-09/2020-12) are informational.
- Serializer & API: v2 accepts dimensional fields and optional `monthly_distribution_id`; server enforces totals = 100% and period alignment.

#### Posting configuration {#posting-config}
Configuration sources and idempotency for accounting postings:

- Chart of Accounts (COA) mappings
  - System-level defaults: AccountsReceivable, Revenue, TaxPayable, Cash/Bank, Inventory, COGS
  - Entity-level overrides: per Product/Service (for InvoiceItem revenue); per WarehouseItem (Inventory account); per Tax rate (TaxPayable); optional Project/WorkOrder revenue/cost centers
  - Precedence: Entity override → System default; validation requires all effective accounts to be resolvable at post time

- Idempotency keys and guards
  - Invoice posting: key = `invoice:{id}:post` (or persisted `posted_journal_id`); re-post is a no-op (409 if forced)
  - Payment receipt: key = `payment:{external_ref|uuid}`; duplicate submissions do not double-apply
  - Inventory consumption: key = `workorder:{id}:consumption` with per-line markers; completion triggers a single posting; re-completion is a no-op
  - Error semantics: 400 for missing mappings/validation failures; 409 for conflicts/already-posted/already-consumed

- Audit and observability
  - ActivityLog entries for each posting with user, entity, and amounts
  - Optional NotificationLog for stock alerts or posting failures

Design notes
- RBAC: finance data is access-controlled with managerial roles required for approvals.
- Audit: all automation actions and report generations are activity-logged.
- Validation: invoices generated from work orders must include correct line items and totals.

## Permission Rules

### Role-Based Access Control
All ViewSets implement role-based filtering in get_queryset():

```python
def get_queryset(self):
    user = self.request.user
    if user.groups.filter(name='Sales Manager').exists():
        # Managers see all records
        return Model.objects.all()
    elif user.groups.filter(name='Sales Rep').exists():
        # Reps see only their owned records
        return Model.objects.filter(owner=user)
    else:
        # Default: user's records only
        return Model.objects.filter(owner=user)
```

### Activity Logging
All create/update operations automatically log activities:

```python
def perform_create(self, serializer):
    instance = serializer.save(owner=self.request.user)
    ActivityLog.objects.create(
        user=self.request.user,
        action='create',
        content_object=instance,
        description=f'Created {instance._meta.model_name}: {instance}'
    )

def perform_update(self, serializer):
    instance = serializer.save()
    ActivityLog.objects.create(
        user=self.request.user,
        action='update',
        content_object=instance,
        description=f'Updated {instance._meta.model_name}: {instance}'
    )
```

## Analytics API

### Dashboard Analytics
```
GET    /api/analytics/dashboard/
Response: {
  "total_accounts": 150,
  "total_contacts": 500,
  "total_deals": 75,
  "total_deal_value": "2500000.00",
  "deals_by_stage": {
    "lead": 20,
    "qualified": 15,
    "proposal": 12,
    "negotiation": 8,
    "won": 15,
    "lost": 5
  },
  "revenue_by_month": [
    {"month": "2025-01", "revenue": "150000.00"},
    {"month": "2025-02", "revenue": "180000.00"}
  ]
}
```

### Deal Predictions
```
GET    /api/analytics/predict/{deal_id}/
Response: {
  "deal_id": 123,
  "predicted_outcome": "win",
  "confidence_score": 85.3,
  "win_probability": 85.3,
  "loss_probability": 10.2,
  "stall_probability": 4.5,
  "factors": {
    "deal_value": 0.25,
    "engagement_frequency": 0.18,
    "time_in_stage": 0.15
  },
  "recommendation": "High confidence for win. Continue current strategy."
}
```

### Customer Lifetime Value
```
GET    /api/analytics/clv/{contact_id}/
Response: {
  "contact_id": 456,
  "lifetime_value": "125000.00",
  "average_order_value": "5000.00",
  "purchase_frequency": 2.5,
  "customer_tenure_days": 730,
  "predicted_next_purchase": "2025-11-15",
  "churn_risk": 0.15,
  "growth_potential": 0.75
}
```

## Error Handling {#error-handling}

### Standard Error Responses
```
400 Bad Request:
{
  "error": "Validation failed",
  "details": {
    "email": ["This field must be unique."],
    "close_date": ["Date cannot be in the past."]
  }
}

401 Unauthorized:
{
  "detail": "Authentication credentials were not provided."
}

403 Forbidden:
{
  "detail": "You do not have permission to perform this action."
}

404 Not Found:
{
  "detail": "Not found."
}

500 Internal Server Error:
{
  "error": "An unexpected error occurred. Please try again."
}
```

## Business Logic Validation

### Account Validation
- name: Required, max 255 characters
- email: Must be valid email format if provided
- annual_revenue: Must be positive decimal if provided
- owner: Auto-assigned to current user on creation

### Deal Validation
- value: Must be positive decimal
- close_date: Cannot be in past
- probability: Must be 0-100 integer
- primary_contact: Must belong to same account
- Stage transitions: Must follow logical progression

### Quote Validation
- valid_until: Must be future date
- tax_rate: Must be 0-100 decimal
- total: Auto-calculated, read-only
- contact: Must belong to same account as quote
- Conversion: Only allowed when status = 'accepted'

## Rate Limiting

### API Limits
- Authenticated users: 1000 requests/hour
- Unauthenticated users: 100 requests/hour
- Bulk operations: 10 requests/minute
- File uploads: 5 uploads/minute

### Headers
```
X-RateLimit-Limit: 1000
X-RateLimit-Remaining: 999
X-RateLimit-Reset: 1638360000
```

---

**All endpoints require authentication unless explicitly marked as public. Use the Authorization header with Token authentication for all requests.**


### Frontend Component Specification

# Converge CRM - Frontend Specification

React frontend component architecture and user interface specifications.

## Architecture Overview

**Framework**: React 19.1.1 + Vite 7.1.7
**State Management**: React Hooks + TanStack Query v5.90.2
**Routing**: React Router v7.9.2
**Styling**: Tailwind CSS v4.1.13 + Custom CSS
**API Client**: Axios v1.12.2 with centralized `api.js`
**Charts**: Chart.js v4.5.0 with react-chartjs-2
**Forms**: React Hook Form v7.63.0

## Component Architecture Patterns

### List Components Pattern
Every entity follows this standardized pattern:

```jsx
const EntityList = () => {
  // State Management
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [currentPage, setCurrentPage] = useState(1);
  const [filters, setFilters] = useState({});

  // API Integration
  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true);
        const response = await api.getEntities({
          search: searchQuery,
          page: currentPage,
          ...filters
        });
        setData(response.data.results);
      } catch (error) {
        setError('Failed to fetch data');
      } finally {
        setLoading(false);
      }
    };

    const debounceTimer = setTimeout(fetchData, 300);
    return () => clearTimeout(debounceTimer);
  }, [searchQuery, currentPage, filters]);

  // Render Structure
  return (
    <div className="container mx-auto px-4 py-6">
      {/* Header Section */}
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold">Entity Management</h1>
        <button className="btn btn-primary">
          Add New Entity
        </button>
      </div>

      {/* Search & Filters */}
      <div className="bg-white rounded-lg shadow p-4 mb-6">
        <div className="flex gap-4">
          <input
            type="text"
            placeholder="Search entities..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="form-input flex-1"
            data-testid="search-input"
          />
          {/* Filters specific to entity */}
        </div>
      </div>

      {/* Data Display */}
      {loading && <LoadingSkeleton />}
      {error && <ErrorMessage message={error} />}
      {!loading && data.length === 0 && <EmptyState />}
      {!loading && data.length > 0 && (
        <>
          <EntityGrid data={data} />
          <Pagination
            currentPage={currentPage}
            onPageChange={setCurrentPage}
            totalPages={Math.ceil(totalCount / 20)}
          />
        </>
      )}
    </div>
  );
};
```

### Detail Components Pattern
```jsx
const EntityDetail = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const [entity, setEntity] = useState(null);
  const [loading, setLoading] = useState(true);
  const [showDeleteModal, setShowDeleteModal] = useState(false);

  // Fetch entity data
  useEffect(() => {
    const fetchEntity = async () => {
      try {
        const response = await api.getEntity(id);
        setEntity(response.data);
      } catch (error) {
        navigate('/entities');
      } finally {
        setLoading(false);
      }
    };

    fetchEntity();
  }, [id]);

  // Delete handler
  const handleDelete = async () => {
    try {
      await api.deleteEntity(id);
      navigate('/entities');
      toast.success('Entity deleted successfully');
    } catch (error) {
      toast.error('Failed to delete entity');
    }
  };

  if (loading) return <LoadingSkeleton />;

  return (
    <div className="container mx-auto px-4 py-6">
      {/* Breadcrumb Navigation */}
      <nav className="text-sm breadcrumbs mb-4">
        <ul>
          <li><Link to="/entities">Entities</Link></li>
          <li>{entity.name}</li>
        </ul>
      </nav>

      {/* Header with Actions */}
      <div className="flex justify-between items-start mb-6">
        <div>
          <h1 className="text-3xl font-bold">{entity.name}</h1>
          <p className="text-gray-600">{entity.subtitle}</p>
        </div>
        <div className="flex gap-2">
          <Link to={`/entities/${id}/edit`} className="btn btn-secondary">
            Edit
          </Link>
          <button
            onClick={() => setShowDeleteModal(true)}
            className="btn btn-danger"
          >
            Delete
          </button>
        </div>
      </div>

      {/* Entity Information Grid */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Main Information */}
        <div className="lg:col-span-2">
          <EntityInfoCard entity={entity} />
          <RelatedEntitiesSection entityId={id} />
          <ActivityTimelineSection entityId={id} />
        </div>

        {/* Sidebar */}
        <div className="space-y-6">
          <EntityStatsCard entity={entity} />
          <QuickActionsCard entityId={id} />
        </div>
      </div>

      {/* Delete Confirmation Modal */}
      {showDeleteModal && (
        <ConfirmationModal
          title="Delete Entity"
          message={`Are you sure you want to delete "${entity.name}"?`}
          onConfirm={handleDelete}
          onCancel={() => setShowDeleteModal(false)}
        />
      )}
    </div>
  );
};
```

### Form Components Pattern
```jsx
const EntityForm = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const isEditing = Boolean(id);

  const [formData, setFormData] = useState({
    name: '',
    email: '',
    // ... other fields
  });
  const [errors, setErrors] = useState({});
  const [loading, setLoading] = useState(false);
  const [initialLoading, setInitialLoading] = useState(isEditing);

  // Load existing data for editing
  useEffect(() => {
    if (isEditing) {
      const fetchEntity = async () => {
        try {
          const response = await api.getEntity(id);
          setFormData(response.data);
        } catch (error) {
          navigate('/entities');
        } finally {
          setInitialLoading(false);
        }
      };

      fetchEntity();
    }
  }, [id, isEditing]);

  // Form validation
  const validateForm = () => {
    const newErrors = {};

    if (!formData.name.trim()) {
      newErrors.name = 'Name is required';
    }

    if (formData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
      newErrors.email = 'Please enter a valid email address';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  // Form submission
  const handleSubmit = async (e) => {
    e.preventDefault();

    if (!validateForm()) return;

    try {
      setLoading(true);

      if (isEditing) {
        await api.updateEntity(id, formData);
        toast.success('Entity updated successfully');
      } else {
        const response = await api.createEntity(formData);
        toast.success('Entity created successfully');
        navigate(`/entities/${response.data.id}`);
        return;
      }

      navigate(`/entities/${id}`);
    } catch (error) {
      toast.error('Failed to save entity');
      if (error.response?.data?.details) {
        setErrors(error.response.data.details);
      }
    } finally {
      setLoading(false);
    }
  };

  if (initialLoading) return <LoadingSkeleton />;

  return (
    <div className="container mx-auto px-4 py-6">
      {/* Form Header */}
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold">
          {isEditing ? 'Edit Entity' : 'Create New Entity'}
        </h1>
      </div>

      {/* Form */}
      <div className="bg-white rounded-lg shadow p-6">
        <form onSubmit={handleSubmit} className="space-y-6">
          {/* Form Fields */}
          <FormField
            label="Name"
            name="name"
            value={formData.name}
            onChange={(value) => setFormData({...formData, name: value})}
            error={errors.name}
            required
          />

          <FormField
            label="Email"
            name="email"
            type="email"
            value={formData.email}
            onChange={(value) => setFormData({...formData, email: value})}
            error={errors.email}
          />

          {/* Form Actions */}
          <div className="flex gap-4 pt-6 border-t">
            <button
              type="submit"
              disabled={loading}
              className="btn btn-primary"
            >
              {loading ? 'Saving...' : (isEditing ? 'Update' : 'Create')}
            </button>

            <button
              type="button"
              onClick={() => navigate('/entities')}
              className="btn btn-secondary"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};
```

## Specific Component Specifications

### AccountList Component
```jsx
// File: frontend/src/components/AccountList.jsx
const AccountList = () => {
  // State: accounts, loading, error, searchQuery, currentPage
  // Filters: industry, annual_revenue_range, owner (if manager)
  // Columns: Name, Industry, Revenue, Contacts, Deals, Owner, Actions
  // Actions: View, Edit, Delete (with confirmation)
  // Empty State: "No accounts found. Create your first account to get started."
  // Search: Debounced search across name, industry fields
  // Pagination: 20 accounts per page
};
```

### AccountDetail Component
```jsx
// File: frontend/src/components/AccountDetail.jsx
const AccountDetail = () => {
  // Sections:
  // 1. Account Info Card (name, industry, revenue, website, phone, address)
  // 2. Related Contacts Section (list with links to ContactDetail)
  // 3. Related Deals Section (pipeline visualization)
  // 4. Interactions Timeline (chronological activity feed)
  // 5. Quick Actions Sidebar (create contact, create deal, log interaction)

  // Business Rules:
  // - Show edit/delete only if user owns account or is manager
  // - Delete requires confirmation and checks for related records
  // - Activity timeline shows all interactions for this account
};
```

### AccountForm Component
```jsx
// File: frontend/src/components/AccountForm.jsx
const AccountForm = () => {
  // Fields: name*, industry, annual_revenue, website, phone, address
  // Validation:
  // - name: required, max 255 chars
  // - website: valid URL format
  // - annual_revenue: positive number
  // - phone: valid phone format

  // Features:
  // - Auto-save drafts every 30 seconds
  // - Industry dropdown with common options + custom entry
  // - Revenue field with currency formatting
  // - Address with Google Maps integration (optional)
};
```

### QuoteDetail Component
```jsx
// File: frontend/src/components/QuoteDetail.jsx
const QuoteDetail = () => {
  // Sections:
  // 1. Quote Header (name, account, contact, status, dates)
  // 2. Line Items Table (product, description, qty, price, discount, total)
  // 3. Totals Section (subtotal, tax, discount, grand total)
  // 4. Actions Section (edit, delete, send, convert to deal)

  // Business Rules:
  // - Convert to Deal only available when status = 'accepted'
  // - PDF generation for sending to customer
  // - Status workflow: draft → sent → accepted/rejected
  // - Line totals auto-calculate: qty * price * (1 - discount%)
};
```

### QuoteForm Component
```jsx
// File: frontend/src/components/QuoteForm.jsx
const QuoteForm = () => {
  // Dynamic Line Items Editor:
  // - Add/remove line items dynamically
  // - Product name autocomplete from previous quotes
  // - Real-time total calculations
  // - Quantity/price validation (positive numbers)

  // Cascading Dropdowns:
  // - Account selection → Contact dropdown updates
  // - Contact must belong to selected account

  // Business Logic:
  // - Tax rate configurable per quote
  // - Discount can be percentage or fixed amount
  // - Valid until date defaults to +30 days
};
```

## Navigation Specification

### Main Navigation Structure
```jsx
// File: frontend/src/App.jsx navigation
<nav className="main-navigation">
  <div className="nav-item">
    <Link to="/dashboard">Dashboard</Link>
  </div>

  <div className="nav-dropdown">
    <button>CRM ▼</button>
    <div className="dropdown-menu">
      <Link to="/accounts">Accounts</Link>
      <Link to="/contacts">Contacts</Link>
      <Link to="/deals">Deals</Link>
      <Link to="/quotes">Quotes</Link>
      <Link to="/interactions">Interactions</Link>
      <Link to="/activity-timeline">Activity Timeline</Link>
    </div>
  </div>

  <div className="nav-dropdown">
    <button>Advanced ▼</button>
    <div className="dropdown-menu">
      <Link to="/analytics/deal-predictions">Deal Predictions</Link>
      <Link to="/analytics/customer-lifetime-value">Customer CLV</Link>
      <Link to="/analytics/revenue-forecast">Revenue Forecast</Link>
    </div>
  </div>

  {/* Other navigation items... */}
</nav>
```

### Route Configuration
```jsx
// File: frontend/src/App.jsx routes
<Routes>
  {/* Authentication */}
  <Route path="/login" element={<LoginPage />} />

  {/* CRM Routes */}
  <Route path="/accounts" element={<ProtectedRoute><AccountList /></ProtectedRoute>} />
  <Route path="/accounts/:id" element={<ProtectedRoute><AccountDetail /></ProtectedRoute>} />
  <Route path="/accounts/new" element={<ProtectedRoute><AccountForm /></ProtectedRoute>} />
  <Route path="/accounts/:id/edit" element={<ProtectedRoute><AccountForm /></ProtectedRoute>} />

  <Route path="/contacts" element={<ProtectedRoute><ContactList /></ProtectedRoute>} />
  <Route path="/contacts/:id" element={<ProtectedRoute><ContactDetail /></ProtectedRoute>} />
  <Route path="/contacts/new" element={<ProtectedRoute><ContactForm /></ProtectedRoute>} />
  <Route path="/contacts/:id/edit" element={<ProtectedRoute><ContactForm /></ProtectedRoute>} />

  <Route path="/quotes" element={<ProtectedRoute><QuoteList /></ProtectedRoute>} />
  <Route path="/quotes/:id" element={<ProtectedRoute><QuoteDetail /></ProtectedRoute>} />
  <Route path="/quotes/new" element={<ProtectedRoute><QuoteForm /></ProtectedRoute>} />
  <Route path="/quotes/:id/edit" element={<ProtectedRoute><QuoteForm /></ProtectedRoute>} />

  {/* Analytics Routes */}
  <Route path="/analytics/deal-predictions" element={<ProtectedRoute><DealPredictions /></ProtectedRoute>} />
  <Route path="/analytics/customer-lifetime-value" element={<ProtectedRoute><CustomerLifetimeValue /></ProtectedRoute>} />
  <Route path="/analytics/revenue-forecast" element={<ProtectedRoute><RevenueForecast /></ProtectedRoute>} />
</Routes>
```

## API Integration Specification

### Centralized API Client
```jsx
// File: frontend/src/api.js
import axios from 'axios';

const api = axios.create({
  baseURL: process.env.REACT_APP_API_URL || 'http://localhost:8000/api',
  timeout: 10000,
});

// Token interceptor
api.interceptors.request.use((config) => {
  const token = localStorage.getItem('authToken');
  if (token) {
    config.headers.Authorization = `Token ${token}`;
  }
  return config;
});

// Error interceptor
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      localStorage.removeItem('authToken');
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);

// Account API methods
export const getAccounts = (params = {}) => api.get('/accounts/', { params });
export const getAccount = (id) => api.get(`/accounts/${id}/`);
export const createAccount = (data) => api.post('/accounts/', data);
export const updateAccount = (id, data) => api.put(`/accounts/${id}/`, data);
export const deleteAccount = (id) => api.delete(`/accounts/${id}/`);

// Quote API methods
export const getQuotes = (params = {}) => api.get('/quotes/', { params });
export const getQuote = (id) => api.get(`/quotes/${id}/`);
export const createQuote = (data) => api.post('/quotes/', data);
export const updateQuote = (id, data) => api.put(`/quotes/${id}/`, data);
export const convertQuoteToDeal = (id) => api.post(`/quotes/${id}/convert-to-deal/`);

export default api;
```

## UI/UX Standards

### Design System
```css
/* Colors */
:root {
  --primary: #3b82f6;      /* Blue */
  --primary-dark: #1d4ed8;
  --secondary: #6b7280;    /* Gray */
  --success: #10b981;      /* Green */
  --warning: #f59e0b;      /* Amber */
  --danger: #ef4444;       /* Red */
  --text-primary: #111827;
  --text-secondary: #6b7280;
  --bg-primary: #ffffff;
  --bg-secondary: #f9fafb;
  --border: #d1d5db;
}

/* Typography */
.text-3xl { font-size: 1.875rem; font-weight: 700; }
.text-2xl { font-size: 1.5rem; font-weight: 600; }
.text-xl { font-size: 1.25rem; font-weight: 500; }

/* Buttons */
.btn {
  @apply px-4 py-2 rounded-lg font-medium transition-colors;
}
.btn-primary { @apply bg-primary text-white hover:bg-primary-dark; }
.btn-secondary { @apply bg-secondary text-white hover:bg-gray-600; }
.btn-danger { @apply bg-danger text-white hover:bg-red-600; }

/* Forms */
.form-input {
  @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary;
}
.form-label {
  @apply block text-sm font-medium text-gray-700 mb-1;
}
.form-error {
  @apply text-sm text-danger mt-1;
}
```

### Responsive Design
- **Mobile First**: All components start with mobile design
- **Breakpoints**: sm (640px), md (768px), lg (1024px), xl (1280px)
- **Grid Layout**: Use CSS Grid for complex layouts, Flexbox for simple alignment
- **Touch Targets**: Minimum 44px for touch interactions

### Accessibility Standards
- **WCAG 2.1 AA Compliance**: All components must meet accessibility standards
- **Keyboard Navigation**: Tab, Enter, Escape, Arrow keys support
- **Screen Reader Support**: Proper ARIA labels and semantic HTML
- **Color Contrast**: 4.5:1 ratio for normal text, 3:1 for large text
- **Focus Indicators**: Visible focus states for all interactive elements

### Loading States
```jsx
// Loading Skeleton Component
const LoadingSkeleton = () => (
  <div className="animate-pulse space-y-4">
    <div className="h-4 bg-gray-200 rounded w-3/4"></div>
    <div className="h-4 bg-gray-200 rounded w-1/2"></div>
    <div className="h-4 bg-gray-200 rounded w-5/6"></div>
  </div>
);

// Loading Button State
<button disabled={loading} className="btn btn-primary">
  {loading ? (
    <>
      <Spinner className="w-4 h-4 mr-2" />
      Loading...
    </>
  ) : (
    'Submit'
  )}
</button>
```

### Error Handling
```jsx
// Error Message Component
const ErrorMessage = ({ message, onRetry }) => (
  <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
    <div className="flex justify-between items-center">
      <span>{message}</span>
      {onRetry && (
        <button onClick={onRetry} className="text-red-600 hover:text-red-800">
          Retry
        </button>
      )}
    </div>
  </div>
);

// Empty State Component
const EmptyState = ({ title, description, action }) => (
  <div className="text-center py-12">
    <div className="text-6xl text-gray-300 mb-4">📋</div>
    <h3 className="text-lg font-medium text-gray-900 mb-2">{title}</h3>
    <p className="text-gray-500 mb-6">{description}</p>
    {action}
  </div>
);
```

---

**All frontend components must follow these patterns and specifications to ensure consistency, maintainability, and optimal user experience.**

### UI/UX House Style Addendum {#uiux-house-style}
- Tables/lists use zebra striping via `.striped-table` class.
- Compact layout: prefer minimal padding and margins to maximize information density.
- Navigation: fixed high-level structure — Dashboard, Resources, Contacts, Deals, Tasks, Orders, Warehouse, Staff.
- Permission affordances: hide or disable actions user cannot perform; always render explanatory helper text on 403.


## 5. Acceptance Criteria {#acceptance-criteria}

- **AC-SYS-001**: All backend and frontend components are implemented according to the specifications in this document.
- **AC-SYS-002**: All user stories are successfully implemented and validated.
- **AC-SYS-003**: All automated tests pass, with a minimum of 70% code coverage for new functionality.
- **AC-SYS-004**: The application is successfully deployed to the target environment.

Field Service and Work Order lifecycle (specific)
- AC-WO-001: Technician assignment SHALL enforce availability, coverage area, and certification requirements; assignment fails with clear errors when constraints are unmet.
- AC-WO-002: Creating a ScheduledEvent for a WorkOrder SHALL create or validate InventoryReservations for required WarehouseItems; on completion, consumption is recorded or reservation is released on cancellation.
- AC-WO-003: Generating an invoice from a WorkOrder SHALL include all LineItems and recorded labor; Payments link to the WorkOrderInvoice and update balances.
- AC-WO-004: Completing a WorkOrder that requires signature SHALL be gated until a valid DigitalSignature is recorded and auditable in NotificationLog where applicable.

## 6. Test Automation Strategy {#test-automation}

- **Test Levels**: Unit, Integration, and End-to-End (E2E) tests are required.
- **Frameworks**: Django's TestCase for the backend, and Jest with React Testing Library for the frontend. Cypress for E2E tests.
- **CI/CD Integration**: All tests MUST be integrated into the GitHub Actions CI/CD pipeline and run on every pull request.
- **Coverage Requirements**: A minimum of 70% test coverage is required for all new code.

### Frontend Test Coverage Gap (visibility)
- Current state: infra is complete, but component test coverage is limited. This is an active gap with business risk.
- Plan: follow the staged implementation described in `spec/frontend-test-coverage-gap-analysis.md` and `spec/frontend-test-implementation-plan.md` (if present). Prioritize revenue-critical surfaces (CRM core, Accounting, Field Service) and raise coverage incrementally per module.
- Gate: do not block merges solely on legacy coverage; enforce 70% coverage on changed lines/files and add suites per sprint until baseline targets are met.

### Cross-Browser & Accessibility Testing {#cross-browser-testing}
- Scope: Chrome (stable), Firefox (latest ESR), Edge (stable), Safari (latest on macOS), and mobile emulations (minimum viable via device profiles). Prioritize CRM core flows.
- Tools: Cypress/Playwright for automation; axe-core for accessibility checks; Lighthouse for performance profiling.
- CI: separate GitHub Actions jobs for cross-browser runs with matrix strategy; store artifacts and summary reports.
- Visual regression: optional per critical views using baseline images and diffs.
- Manual procedures: follow spec/cross-browser/manual testing procedures for edge browsers and devices.

## 7. Rationale & Context {#rationale}

This master specification ensures that all development work is aligned with the architectural vision and business requirements of the Converge CRM platform. By providing a single source of truth, it facilitates consistency, reduces ambiguity, and enables more efficient development and testing.

## 8. Dependencies & External Integrations {#dependencies}

### Backend Dependencies
- **PLT-BE-001**: Django 5.2.6
- **PLT-BE-002**: Django REST Framework
- **PLT-BE-003**: PostgreSQL (for production)

### Frontend Dependencies
- **PLT-FE-001**: React 19.1.1
- **PLT-FE-002**: Vite 7.1.7
- **PLT-FE-003**: React Router v7.9.2
- **PLT-FE-004**: Axios v1.12.2
- **PLT-FE-005**: Tailwind CSS v4.1.13

## 9. Examples & Edge Cases {#examples}

(Examples are provided within the backend and frontend specification sections.)

## 10. Validation Criteria {#validation}

- **VAL-001**: All Django models match the field specifications and constraints.
- **VAL-002**: All API endpoints implement the required RBAC and activity logging.
- **VAL-003**: All React components adhere to the specified architectural patterns.
- **VAL-004**: The final application successfully passes all acceptance criteria.

## 11. Process Quality: ESLint Baseline Diffs and Gates {#process-eslint-baseline}

Purpose: prevent regression of legacy lint debt while enabling incremental improvements.

Key patterns
- Baseline file: `frontend/lint-baseline.json` (and optional batches, e.g., `lint-baseline-batch3.json`).
- Snapshot artifact: `docs/reports/lint-snapshot.json` with per-rule counts and totals.
- Report: `docs/reports/lint-baseline-diff.md` with sections: Current Totals; Baseline Comparisons; Per-Rule Changes (Top Regressions/Improvements); Quality Gate Result; Invocation Parameters.
- Thresholds: `MaxTotalDelta`, `MaxRuleDelta` (default 0 in gate tasks) – fail build on positive deltas.
- Windows-first: PowerShell 5.1 script entrypoint `tools/lint_baseline_diff.ps1`; CI uses Node/ESLint via npx.

Interfaces
- VS Code tasks
  - lint: ci-parity → `npx eslint --max-warnings=0 --ext .js,.jsx,.ts,.tsx src` (cwd: `frontend`).
  - lint: baseline-diff → run PowerShell script to generate snapshot/report (non-gating by default).
  - lint: gate-baseline → same script with `-MaxTotalDelta 0 -MaxRuleDelta 0` (gating).
- Script parameters: `-SnapshotOut`, `-MaxTotalDelta`, `-MaxRuleDelta`, `-TopN`.

Operational guardrails
- Prefer deterministic CI console output; put detail in Markdown artifacts.
- ASCII-only console strings (use "delta", avoid Unicode symbols) for PS 5.1.
- No network access; do not collect source or secrets; store only counts.
- Fallback parsing: if ESLint JSON unavailable, derive totals from text and omit per-rule deltas with a warning.

Acceptance checks
- No-change vs baseline: gate passes and report marks NO CHANGE.
- Any new violation with thresholds at 0: non-zero exit and report shows REGRESSED with top rule deltas.

## 12. Related Specifications / Further Reading {#related}
Primary references
- Developer Guide: ../../docs/DEVELOPMENT.md
- API Reference: ../../docs/API.md
- Testing Automation: ../../docs/TESTING_AUTOMATION.md
- User Stories (source of truth): ../../static/kb/user-stories.md

Spec-driven development assets
- Master AI Spec: ../../main.md
- Compile Prompt: ../../.github/prompts/compile.prompt.md
- Lint Prompt: ../../.github/prompts/lint.prompt.md

Module specifications
- Accounting Expansion: ../../spec/spec-design-accounting-expansion.md
- Phase 4 Technician/User Management: ../../spec/spec-design-phase4-technician-user-management.md
- Field Service Management: ../../spec/spec-design-field-service-management.md

Cross-browser suite (reference)
- Strategy, matrix, automation, and procedures: ../../spec/cross-browser/

---

## 13. Acceptance Mapping {#acceptance-mapping}

Traceability matrix linking design areas to current automated tests. Update when specs or tests change to prevent drift.

- Deal → Project automation (Signals):
  - Tests: `main/tests.py` (Workflow automation), `main/tests_commands.py` (recurrence rules)
- Technician & User Management (Phase 4A):
  - Tests: `main/tests.py::Phase4ATechnicianManagementTests`
- Accounting Expansion (Phase 1):
  - Tests: `main/tests.py::Phase1AccountingTests`
- Workflow Automation (Phase 2):
  - Tests: `main/tests.py::Phase2WorkflowTests`
- Authentication & Permissions:
  - Tests: `main/tests/test_permissions_minimal.py`, `main/tests/test_permissions_deeper.py`, `main/tests/test_permissions_payments_journal.py`

- Field Service Management:
  - Tests: `main/tests.py` (ScheduledEvent, Notifications, Paperwork, Signatures, InventoryReservation, SchedulingAnalytics)
  - Tests: `main/tests/test_search_and_routes.py` (optimize routes endpoints)
  - Tests: `main/test_phase2.py` (technician assignment notifications and recurrence)

- Accounting Posting (see {#ac-gl}):
  - AC-GL-001 (Invoice posting → JournalEntry): Tests implemented `main/tests/test_posting_invoice.py::TestInvoicePosting`
  - AC-GL-002 (Payment receipt → JournalEntry, AR settlement): Tests implemented `main/tests/test_posting_payment.py::TestPaymentPostingGL`
  - AC-GL-003 (Inventory consumption on WorkOrder completion → JournalEntry): Tests implemented `main/tests/test_posting_inventory.py::TestWorkOrderConsumptionPosting`

### Accounting Posting Acceptance Criteria {#ac-gl}

- AC-GL-001 Invoice Posting → Journal Entry
  - Preconditions: A posted Invoice exists with one or more InvoiceItems and valid LedgerAccount mappings for Accounts Receivable and Revenue (and Tax if applicable).
  - Action: POST /api/invoices/{id}/post/ or equivalent posting action.
  - Expected:
    - Creates a JournalEntry with two or more lines obeying double-entry invariants:
      - DR AccountsReceivable = invoice.total_gross
      - CR Revenue = invoice.total_net
      - If tax applicable: CR TaxPayable = invoice.total_tax
    - Idempotency: Re-posting the same invoice does not create duplicate JournalEntries.
    - Invoice status transitions to Posted; AR balance reflects the invoice total.
    - Audit: ActivityLog records the posting event with user and invoice reference.
    - Error modes: Missing COA mapping → 400 with explicit field; Already posted → 409.

- AC-GL-002 Payment Receipt → Journal Entry and AR Settlement
  - Preconditions: A Posted Invoice with open balance; a valid Cash/Bank LedgerAccount mapping.
  - Action: POST /api/payments/ with invoice reference and amount (supports partial payments).
  - Expected:
    - Creates a JournalEntry:
      - DR Cash/Bank = payment.amount
      - CR AccountsReceivable = payment.amount
    - Applies payment to the referenced Invoice, reducing its balance; status transitions to Paid when balance == 0.
    - Partial payments: Invoice status transitions to Partially Paid; remaining balance accurate.
    - Idempotency: Retrying the same payment reference doesn’t double-apply.
    - Validation: Reject overpayment (amount > open balance) with 400.
    - Audit: ActivityLog records payment creation and application.

- AC-GL-003 Inventory Consumption on Work Order Completion → Journal Entry
  - Preconditions: WorkOrder with consumed LineItems that reference WarehouseItem with unit_cost > 0; valid Inventory and COGS LedgerAccount mappings; sufficient stock.
  - Action: PATCH /api/work-orders/{id}/complete/ or completion event that triggers consumption.
  - Expected:
    - For each consumed part line: decrements WarehouseItem.quantity by line.quantity.
    - Creates a JournalEntry totaling cost:
      - DR CostOfGoodsSold = sum(line.quantity × warehouse_item.unit_cost for part lines)
      - CR Inventory = same amount
    - Prevents negative inventory; returns 409 if insufficient stock unless backorder override is specified.
    - Idempotency: Completing the same WorkOrder twice does not double-consume inventory nor double-post GL.
    - Audit: ActivityLog records consumption and posting; NotificationLog may capture stock alerts.

Note: Keep acceptance mapping concise; reference folders/files rather than duplicating content.

- [User Stories](../../static/kb/user-stories.md)
- [Development Guide](../../docs/DEVELOPMENT.md)

---

## 14. Processed Sources (provenance) {#processed-sources}
Concise list of source documents and code artifacts consolidated into this canonical spec, with primary anchors used.

- .github/copilot-instructions.md
  - Architecture Overview; Project-Specific Patterns; API Endpoint Patterns; Frontend Component Organization; Database Model Relationships; Testing Automation Infrastructure; Phase 4 Technician & User Mgmt; Phase 5 Field Service Mgmt
- spec/spec-design-accounting-expansion.md → summarized in Accounting & Workflow Expansion Summary
- spec/spec-process-lint-baseline-gating[processed].md → Process Quality: ESLint Baseline Diffs and Gates
- spec/cross-browser/* → Cross-Browser & Accessibility Testing
- docs/TESTING_AUTOMATION.md → Test Automation Strategy section
- main/api_urls.py → Canonical endpoints for auth, technician, and field service APIs
- main/models.py → Model field references for Technician, ScheduledEvent, NotificationLog, PaperworkTemplate, AppointmentRequest, DigitalSignature, InventoryReservation, SchedulingAnalytics



## 3. Source: spec/design.md

# Design Overview

## Architecture
- Backend: Django + DRF, token auth, activity logging
- Frontend: React + Vite, Axios client, SPA routing

## Data Flow
- API-driven, REST endpoints consumed by frontend via centralized client

## Interfaces
- REST endpoints as documented in spec-design-master.md

## Error Handling
- Standardized JSON error responses with appropriate HTTP status codes



## 4. Source: spec/requirements.md

# Requirements (EARS)

- WHEN a user authenticates with valid credentials, THE SYSTEM SHALL return a token and user profile.
- WHEN a Sales Rep views accounts, THE SYSTEM SHALL filter records to those owned by the user.
- WHEN a Sales Manager views accounts, THE SYSTEM SHALL return all records.
- WHEN a deal is updated to stage 'won', THE SYSTEM SHALL automatically create a Project linked to the deal.
- IF an invoice is overdue, THEN THE SYSTEM SHALL send automated reminder emails to the customer.



## 5. Source: spec/spec-design-accounting-expansion.md

---
title: Converge Accounting & Workflow Expansion Specification
version: 1.0
date_created: 2025-09-29
last_updated: 2025-10-09
owner: Converge Product Team
tags: [design, accounting, workflow, roadmap, expansion]
---

# Introduction

This specification defines a two-phase expansion plan for the Converge CRM accounting and business workflow modules. The goal is to deliver a comprehensive financial management suite (Phase 1) and then enable advanced workflow automation and cross-module integration (Phase 2).

## 1. Purpose & Scope

This document provides requirements, constraints, and design guidelines for expanding the accounting and workflow capabilities of Converge. It is intended for developers, architects, and product managers. Assumes the current accounting foundation is in place (Ledger, WorkOrder, Invoice, Payment, etc.).

## 2. Definitions

- **GL**: General Ledger
- **P&L**: Profit and Loss Statement
- **CRUD**: Create, Read, Update, Delete
- **KPI**: Key Performance Indicator
- **RBAC**: Role-Based Access Control
- **Deal-to-Cash**: Workflow from sales deal closure to payment collection

## 3. Requirements, Constraints & Guidelines

### Phase 1: Complete Financial Management Suite
- **REQ-101**: Implement financial reports: Balance Sheet, P&L, Cash Flow Statement
- **REQ-102**: Enable automatic invoice generation from WorkOrders
- **REQ-103**: Add payment terms, late fees, and reminders to invoices
- **REQ-104**: Implement dedicated expense tracking with receipt upload and categorization
- **REQ-105**: Add budget planning and variance tracking
- **REQ-106**: Provide tax reporting features (e.g., 1099, sales tax tracking)
- **SEC-101**: All financial data must be access-controlled by RBAC
- **CON-101**: Reports must be exportable as PDF and CSV
- **GUD-101**: UI must provide clear navigation between accounting features

### Budget v2 and MonthlyDistribution (Dimensional Budgeting)
- **REQ-107**: Introduce Budget v2 with dimensions: Cost Center (required) and Project (optional).
- **REQ-108**: Implement MonthlyDistribution as a separate document linking to a Budget v2 to represent 12-month allocation percentages that sum to 100%.
- **REQ-109**: Provide a migration mapping table (admin-manageable) to map legacy Budget records to v2 with default dimensions.
- **CON-107**: Default Cost Center must be "General Operations" when source data lacks a value.
- **CON-108**: Default MonthlyDistribution must be 12 equal allocations of 8.33% each (tolerate rounding to 100%).
- **SEC-107**: Only finance-role users may create or modify Budget v2 and distributions; all changes activity-logged.
- **PAT-107**: Use JSON Schema draft-07 as the authoritative contract for Budget v2 and MonthlyDistribution; provide 2019-09/2020-12 variants as informational only.

### Phase 2: Enhanced Workflow Automation
- **REQ-201**: Implement automatic WorkOrder creation upon Deal closure
- **REQ-202**: Enable project billing: time tracking → billable hours → invoicing
- **REQ-203**: Integrate inventory: WorkOrders adjust Warehouse stock
- **REQ-204**: Add customer communication automation (invoice emails, reminders)
- **REQ-205**: Provide cross-module analytics (sales, project profitability, CLV)
- **PAT-201**: Use event-driven architecture for workflow triggers
- **SEC-201**: All automation actions must be logged for audit

## 4. Interfaces & Data Contracts

| API Endpoint                | Method | Description                                 |
|----------------------------|--------|---------------------------------------------|
| /api/reports/balance-sheet | GET    | Retrieve balance sheet report               |
| /api/reports/pnl           | GET    | Retrieve profit & loss statement            |
| /api/reports/cash-flow     | GET    | Retrieve cash flow statement                |
| /api/expenses/             | CRUD   | Manage expenses and receipts                |
| /api/budgets/              | CRUD   | Manage budgets and track variances          |
| /api/tax-reports/          | GET    | Generate tax-related reports                |
| /api/workorders/auto       | POST   | Auto-create WorkOrder from Deal             |
| /api/billing/time          | POST   | Log billable time for project billing       |
| /api/inventory/adjust      | POST   | Adjust inventory from WorkOrder             |
| /api/communications/email  | POST   | Send automated emails (invoices, reminders) |
| /api/budgets-v2/           | CRUD   | Manage dimensional budgets (Cost Center, Project) |
| /api/monthly-distributions/| CRUD   | Manage monthly allocation templates for budgets     |

**Data Contract Example: Expense**
```json
{
  "id": 123,
  "date": "2025-09-29",
  "amount": 250.00,
  "category": "Travel",
  "description": "Flight to client site",
  "receipt_url": "/media/receipts/123.pdf"
}
```

**Data Contract Example: Budget v2 (request)**
```json
{
    "name": "FY2026 Field Service Ops",
    "period_start": "2026-01-01",
    "period_end": "2026-12-31",
    "amount": "120000.00",
    "cost_center": "General Operations",
    "project_id": null,
    "monthly_distribution_id": 7
}
```

**Data Contract Example: MonthlyDistribution**
```json
{
    "name": "Equal-12",
    "percentages": [8.33,8.33,8.33,8.33,8.33,8.33,8.33,8.33,8.33,8.33,8.33,8.37]
}
```

## 5. Acceptance Criteria

- **AC-101**: Given a set of transactions, when a user requests a Balance Sheet, then the correct report is generated and downloadable
- **AC-102**: When a WorkOrder is completed, an invoice can be generated automatically with correct line items
- **AC-103**: When an expense is logged, a receipt can be uploaded and categorized
- **AC-201**: When a Deal is marked as closed, a WorkOrder is created and linked
- **AC-202**: When time is logged on a Project, it can be billed and invoiced
- **AC-203**: When a WorkOrder is fulfilled, inventory is decremented accordingly
- **AC-204**: When an invoice is overdue, an automated reminder email is sent

## 6. Test Automation Strategy

- **Test Levels**: Unit, Integration, End-to-End
- **Frameworks**: Django TestCase, DRF APIClient, React Testing Library, Playwright
- **Test Data Management**: Use factories for transactions, expenses, and deals
- **CI/CD Integration**: All tests run in GitHub Actions on PRs to main
- **Coverage Requirements**: 90%+ for backend, 80%+ for frontend
- **Performance Testing**: Simulate report generation with large datasets

## 7. Rationale & Context

Phase 1 addresses core business needs for financial management, reducing reliance on external accounting tools. Phase 2 leverages the platform’s modularity to automate business processes, increasing efficiency and data accuracy.

## 8. Dependencies & External Integrations

### External Systems
- **EXT-101**: Email delivery service (e.g., SendGrid) for automated communications

### Third-Party Services
- **SVC-101**: PDF/CSV export library for report generation

### Infrastructure Dependencies
- **INF-101**: Secure file storage for receipts and exports

### Data Dependencies
- **DAT-101**: Accurate and timely transaction data for reporting

### Technology Platform Dependencies
- **PLT-101**: Django 5.x, React 18+, DRF, PostgreSQL

### Compliance Dependencies
- **COM-101**: Financial data retention and audit requirements

## 9. Examples & Edge Cases

```python
# Example: Auto-create WorkOrder from Deal closure
def on_deal_closed(deal):
    work_order = WorkOrder.objects.create(
        deal=deal,
        ... # populate fields
    )
    return work_order

# Edge Case: Expense with missing receipt
expense = Expense.objects.create(
    amount=100,
    category="Meals",
    receipt_url=None  # Should be allowed but flagged for review
)
```

## 10. Validation Criteria

- All endpoints return correct data and enforce permissions
- Reports match accounting standards and are exportable
- Automation triggers are reliable and auditable
- UI/UX meets navigation and accessibility guidelines

## 11. Related Specifications / Further Reading

- [spec-schema-accounting.md](spec-schema-accounting.md) (to be created)
- [Django/DRF documentation](https://www.django-rest-framework.org/)
- [OWASP security guidelines](https://owasp.org/www-project-top-ten/)



## 6. Source: spec/spec-design-accounting-expansion[processed].md

---
title: [Processed] Accounting & Workflow Expansion
version: 1.0
date_processed: 2025-10-10
owner: Converge Product Team
tags: [processed, accounting, workflow]
---

Design patterns and endpoints from this document have been consolidated into the master spec:

- Section: "Accounting & Workflow Expansion Summary" (#accounting-workflow-summary) in `spec/spec-design-master.md`.
- Related APIs listed under Interfaces & Data Contracts.

Original document retained only as a processed marker.



## 7. Source: spec/spec-design-field-service-management.md

---
title: Field Service Management Specification (Stub)
version: 0.1-draft
date_created: 2025-10-10
last_updated: 2025-10-10
owner: Converge Product Team
tags: [design, field-service, scheduling, signatures]
---

# Field Service Management

Authoritative specification for scheduling, notifications, paperwork, customer appointment requests, digital signatures, inventory reservations, and scheduling analytics.

## 1. Purpose & Scope
Deliver a complete Field Service capability integrated with Projects/WorkOrders: technician scheduling (with recurrence), customer communications (reminders and on-my-way), paperwork with signatures, inventory reservation/consumption, and scheduling analytics.

## 2. Requirements & Constraints
- Must integrate with existing WorkOrder and Project models.
- Scheduling supports recurrence via RRULE strings and parent/child instances.
- Notifications are auditable in a systemwide `NotificationLog` with status lifecycle.
- Paperwork templates allow HTML with conditional logic; optional signatures required.
- Digital signatures store integrity metadata (document_hash, is_valid) for verification.
- Inventory is reserved at scheduling time and consumed upon completion.
- Scheduling analytics recorded daily with KPIs for utilization and completion.

## 3. Domain Models (source of truth: main/models.py)

### ScheduledEvent
- Fields: work_order (FK), technician (FK), start_time, end_time, recurrence_rule (RRULE), parent_event (self FK), status (scheduled|in_progress|completed|cancelled|rescheduled), notes, timestamps.
- Manager: ScheduledEventManager supports legacy kwargs (project, appointment_date, string times) and auto-creates WorkOrder for a Project.
- Behavior: duration_hours, is_overdue; ordering by start_time.

### NotificationLog
- Generic link to any object; recipient, channel (email|sms|push), subject, message, status (pending|sent|failed|delivered|bounced), sent_at/delivered_at, error_message, external_id.
- Purpose: Audit trail for all auto-sent messages.

### PaperworkTemplate
- name (unique), description, content (HTML with Django template syntax), is_active, requires_signature, created_by, timestamps.

### AppointmentRequest
- account, contact, requested_start_time/end_time, work_description, priority, status (pending|approved|denied|scheduled), reviewed_by/at, review_notes, scheduled_event (OneToOne), timestamps.

### DigitalSignature
- Generic link to target (e.g., WorkOrder); signature_data (base64), signer_name/email, document_name, paperwork_template?, ip_address, user_agent, signed_at, is_valid, document_hash.

### InventoryReservation
- scheduled_event, warehouse_item, quantity_reserved, quantity_consumed, status (reserved|allocated|consumed|released), reserved_by, timestamps; unique together (scheduled_event, warehouse_item).

### SchedulingAnalytics
- date (unique), totals (technicians, active_technicians, total_scheduled_events, completed/cancelled/rescheduled), metrics (on_time_completion_rate, average_travel_time_minutes), customer_satisfaction_score; daily snapshot creator.

## 4. API Endpoints (source: main/api_urls.py)

Resource ViewSets
- /api/scheduled-events/
- /api/notification-logs/
- /api/paperwork-templates/
- /api/appointment-requests/
- /api/digital-signatures/
- /api/inventory-reservations/
- /api/scheduling-analytics/

Scheduling helpers
- POST /api/scheduling/route-optimization/
- GET  /api/scheduling/availability-check/

Notifications
- POST /api/notifications/send-reminder/
- POST /api/notifications/send-on-way/

Assignment (Phase 4 linkage)
- POST /api/work-orders/{id}/find-technicians/
- POST /api/work-orders/{id}/assign-technician/
- GET  /api/technicians/available/

## 5. Frontend Components

### SchedulePage.jsx
- Calendar view (FullCalendar or equivalent), drag-and-drop scheduling, recurrence editing.
- Filters: technician, status, date range. Inline creation of ScheduledEvent.
- Actions: reschedule, mark completed, cancel; invokes notifications where applicable.

### PaperworkTemplateManager.jsx
- CRUD for templates; live preview of HTML with variable insertion; toggle requires_signature.

### CustomerPortal.jsx
- Appointment request form with account/contact linkage; available slot preview; submits to /api/appointment-requests/.

### AppointmentRequestQueue.jsx
- Manager view to approve/deny requests; on approve, creates ScheduledEvent and links; records reviewer and notes.

### DigitalSignaturePad.jsx
- Capture signature as base64, store metadata; verify and persist document_hash and is_valid.

### SchedulingDashboard.jsx
- Visualize SchedulingAnalytics: utilization, completion rates, counts per day; trend charts.

### WorkOrderList.jsx (enhancement)
- "On My Way" button triggering /api/notifications/send-on-way/ for the next event.

## 6. Business Rules
- Assignment must honor WorkOrderCertificationRequirement; block or warn when unmet.
- Technicians must be available and within a valid coverage area; route optimization endpoint can suggest efficient sequencing.
- Paperwork marked requires_signature cannot be completed until a valid DigitalSignature exists.
- Inventory reservations created at scheduling; consumption on completion; release on cancellation.

## 6A. Schema Posture & Validation
- Schema enums: Keep client-facing JSON Schemas minimally constrained (avoid brittle enumerations for statuses beyond core values) to allow operational flexibility and provider changes.
- RRULE validation: Accept RRULE strings in API; perform server-side expansion/validation, including timezone considerations and exception dates.
- State transitions: Validate transitions (scheduled→in_progress→completed|cancelled|rescheduled) on the server; reject invalid transitions with clear errors.
- Auditability: All validations and transition outcomes must be activity-logged for traceability.

## 7. Acceptance Criteria and Test Links
- AC-FS-001: Create single and recurring ScheduledEvent; duration and overdue behave correctly.
	- Tests: main/test_phase2.py (recurrence, notifications); main/tests.py (ScheduledEvent behaviors)
- AC-FS-002: Approving AppointmentRequest creates a ScheduledEvent and links it.
	- Tests: main/tests.py (appointment request flows, if present)
- AC-FS-003: Sending reminders and on-my-way logs NotificationLog entries with correct channels/status.
	- Tests: main/test_phase2.py::test_send_technician_assignment_notification; main/tests.py (notification log behaviors)
- AC-FS-004: DigitalSignature persists integrity fields and links to paperwork/work orders.
	- Tests: main/tests.py (DigitalSignature model and API)
- AC-FS-005: InventoryReservation enforces unique pairs, supports release and consume flows.
	- Tests: main/tests.py (inventory reservation flows)
- AC-FS-006: SchedulingAnalytics daily snapshots compute KPI fields.
	- Tests: main/tests.py (SchedulingAnalytics.create_daily_snapshot)
- AC-FS-007: Route optimization and availability check endpoints respond and validate inputs.
	- Tests: main/tests/test_search_and_routes.py (optimize- routes)

## 8. Security & Permissions
- RBAC: Managers see all; reps limited; sensitive actions (approve, assign, send notifications) restricted by role.
- Audit: All create/update actions activity-logged; NotificationLog is immutable history.

## 9. Error Handling
- Consistent DRF errors for validation and permission issues; provide user-friendly messages in UI for failed notifications and scheduling conflicts.

## 10. Observability
- Store artifacts for route optimization runs and notification attempts in logs; surface aggregated metrics via SchedulingAnalytics.



## 8. Source: spec/spec-lineup-cannon-features-25.md

# Spec Lineup — 25% Canonical Feature Alignment Plan (Milestone M2)

Date: 2025-10-11
Status: Proposed → In Progress upon approval
Owner: Platform Engineering (Backend/Frontend/QA)
Target: Raise canonical spec alignment to ~25%

## Objective
Deliver the first production-grade slices for Inventory GTIN utilities and Accounting Budget v2, turning prior research and dev tooling into shippable features with tests, docs, and safe migrations.

This milestone implements:
- Utilities: GTIN check-digit helper API (server) and client usage path
- Inventory: WarehouseItem.gtin field + validation (digits-only, check-digit)
- Accounting: Budget v2 + MonthlyDistribution minimal viable models, CRUD APIs, and seed data
- Documentation updates and JSON Schema publication for the above
- Automated tests (backend + frontend smoke), quality gates, and migration safety

Out of scope (deferred to later milestones): durable posting hardening expansions, full scheduling optimizations, payroll, and advanced analytics.

## Success Criteria (Acceptance)
1. Utilities API
   - GET /api/utils/gtin/check-digit/?gtin_base= returns computed check digit and normalized 14-digit GTIN (digits only).
   - Input validation returns 400 with structured error on non-digit input or invalid length.
   - API documented in docs/API.md; example requests and responses included.

2. Inventory — WarehouseItem.gtin
   - Model includes nullable `gtin` CharField(max_length=14) with digits-only constraint.
   - Serializer validates digits-only and, when length is 14, validates check digit; if <14, accepts but normalizes/stores as digits-only string; no formatting characters stored.
   - Create/Update endpoints reject invalid data with specific errors; admin and list/detail serializers include `gtin`.
   - MSW handler and frontend form accept/display `gtin` (optional field) with basic client-side digits-only restriction.

3. Accounting — Budget v2 + MonthlyDistribution
   - New models and CRUD APIs exist: BudgetV2 and MonthlyDistribution (1:12 mapping per budget; values sum to 100%).
   - BudgetV2 requires Cost Center (FK), optional Project (FK). Defaults during migration: Cost Center = “General Operations” (created if missing); MonthlyDistribution seeded to 12 × 8.33% (last month adjusts rounding to reach 100%).
   - List/create/update/delete endpoints wired via DRF Router; permissions aligned to existing RBAC patterns.
   - JSON Schemas published (draft-07) and linked from master spec; dev validator can validate example payloads.

4. Tests & Quality Gates
   - Backend: New tests for Utilities API, WarehouseItem serializer, BudgetV2 and MonthlyDistribution models/serializers/views. Minimum +12 tests added, all green locally and in CI.
   - Frontend: Jest test(s) cover rendering of GTIN field and basic digits-only client behavior; MSW handlers added. Cypress E2E optional smoke for creating a BudgetV2 with default distribution.
   - Quality gates: Lint PASS, Tests PASS, Coverage unchanged or improved; pre-commit hooks clean.

5. Documentation & Spec
   - spec/spec-design-master.md references the new endpoints and fields; JSON Schema Catalog lists BudgetV2 and MonthlyDistribution schemas, plus WarehouseItem with optional `gtin`.
   - docs/API.md includes: Utilities GTIN endpoint, WarehouseItem.gtin rules, Budget v2 endpoints with examples, and “Schema usage” cross-links.

## Scope of Work

### Backend (Django/DRF)
- Utilities
  - Add GET /api/utils/gtin/check-digit/ in `main/api_views.py` and route in `main/api_urls.py`.
  - Logic: validate digits-only input; accept 7–13 digit base; compute 14th check digit per GS1; return normalized 14-digit GTIN.
- Inventory
  - Add `gtin` CharField(max_length=14, null=True, blank=True) to `WarehouseItem` in `main/models.py` with migration.
  - Extend `WarehouseItem` serializer validation: digits-only; if len==14, verify check digit; otherwise allow shorter digits (stored as-is) with normalization to digits-only.
  - Update `admin.py` to include `gtin` in list_display/search_fields where applicable.
- Accounting
  - Add models: `BudgetV2` and `MonthlyDistribution` with constraints (12 rows per budget; total 100%).
  - Serializers and `ModelViewSet` endpoints; DRF router wiring; permissions per existing patterns.
  - Data migration to create default Cost Center “General Operations” if absent; backfill distribution 12 × 8.33% with rounding fix.
- JSON Schemas
  - Author and publish draft-07 schemas: `BudgetV2`, `MonthlyDistribution`; update `WarehouseItem` schema to include optional `gtin` with pattern ^\d{7,14}$ and example.
  - Ensure dev validator endpoint recognizes these schema keys.

### Frontend (React/Vite)
- API client: add Utilities call for GTIN check-digit; expose a helper function.
- Warehouse UI: surface an optional GTIN input on Warehouse item forms (digits-only input mask/validation message; no heavy UX required this milestone).
- Minimal Budget V2 screens not required; optionally add a basic read-only list page wired to new endpoint for smoke testing, if capacity allows.
- Tests: Jest component test(s) for GTIN input and api helper; MSW handler for Utilities endpoint; update coverage thresholds if needed.

### Documentation & Spec
- Update `spec/spec-design-master.md` with canonical links and brief descriptions for:
  - Utilities GTIN endpoint
  - WarehouseItem.gtin field
  - BudgetV2 and MonthlyDistribution with distribution rule
- Update `docs/API.md` with:
  - Endpoint details and examples (request/response) for Utilities and Budget v2
  - WarehouseItem.gtin validation notes and examples
  - Links to JSON Schema catalog and dev validator instructions

### CI/CD & DevEx
- Ensure tests run in existing workflows.
- No new secrets or external services required.
- Add lightweight factory or fixture data for tests and optional seed command augmentation.

## Detailed Tasks Checklist

- Utilities (GTIN)
  - [ ] View + URL: /api/utils/gtin/check-digit/
  - [ ] Input validation and GS1 check-digit computation
  - [ ] Unit tests (valid, invalid length, non-digit, boundary cases)
  - [ ] API docs update with examples
  - [ ] Frontend helper and MSW handler + test

- Inventory (WarehouseItem.gtin)
  - [ ] Model field + migration
  - [ ] Serializer validation + tests (create/update)
  - [ ] Admin/list serializers include field
  - [ ] API docs update and schema update
  - [ ] Frontend optional input wiring + test

- Accounting (Budget v2 + MonthlyDistribution)
  - [ ] Models + migrations with constraints
  - [ ] Serializers, ViewSets, Router wiring
  - [ ] Default Cost Center data migration and distribution seeding
  - [ ] Backend tests (models, serializers, API CRUD)
  - [ ] API docs and JSON Schemas

- Documentation & Spec
  - [ ] Master spec updates + JSON Schema Catalog entries
  - [ ] API.md updates
  - [ ] Dev validator schema keys registered

- Quality Gates
  - [ ] Flake8/isort/Black clean
  - [ ] Jest/Cypress (optional smoke) passing
  - [ ] Coverage stable or improved

## Contracts and Rules (Quick Reference)
- GTIN digits-only normalization; provide 14-digit normalized output when check digit computed.
- WarehouseItem.gtin accepts 7–14 digits; if 14 digits, check digit must be valid; storage is digits-only.
- BudgetV2 requires Cost Center; Project optional; MonthlyDistribution totals 100% across 12 months.
- JSON Schema baseline: draft-07; variants remain informational.

## Testing Strategy
- Backend
  - Utilities: parameterized tests for GTIN bases (7–13 digits) producing correct check digits; negative tests for non-digit and length.<14 with non-digit.
  - WarehouseItem: serializer create/update tests; round-trip GET includes `gtin`.
  - BudgetV2/MonthlyDistribution: model constraint tests (12 rows), sum-to-100 validation, CRUD API tests, data migration test ensuring default cost center and seeded distribution.
- Frontend
  - Unit: digits-only GTIN input behavior; API helper happy/invalid paths with MSW.
  - E2E (optional): create BudgetV2 via UI or API-backed fixture and verify distribution total.

## Risks and Mitigations
- Data Integrity: Enforce digits-only and check-digit rules server-side; add DB-level constraints where safe.
- Rounding Drift: Final month adjusts to hit 100%; include explicit test.
- Backwards Compatibility: `gtin` is nullable; serializers remain compatible.
- Scope Creep: Defer advanced scheduling and posting hardening; keep UI minimal.

## Rollout and Backout
- Rollout: Standard migration sequence; deploy backend first; frontend change is additive.
- Backout: Safe due to additive changes; if needed, revert migrations and hide GTIN field in UI.
- Feature Flags: Not required; endpoints are additive and guarded by validation.

## Timeline and Effort (Indicative)
- Backend (GTIN + Inventory): 1.5–2.0 days including tests
- Backend (Budget v2): 2.0–3.0 days including models, migrations, tests
- Frontend: 0.5–1.0 day (helper, MSW, input, tests)
- Docs & Spec: 0.5 day
- Buffer/Review: 0.5 day
Total: ~5 days elapsed (single engineer); parallelization reduces calendar time.

## Definition of Done
- All acceptance criteria satisfied.
- Tests PASS locally and in CI; lint PASS; coverage stable or improved.
- docs/API.md and spec/spec-design-master.md updated; JSON Schemas published.
- Endpoint live and discoverable; minimal UI present for GTIN input.
- Alignment reported at ~25% with traceable mapping to canonical spec sections.

## Traceability (Canonical Spec ↔ Implementation)
- Utilities (GTIN): spec-design-master.md → Utilities API; new endpoint /api/utils/gtin/check-digit/
- Inventory: WarehouseItem.gtin field — spec master “Warehouse Management” + JSON Schema Catalog
- Accounting: Budget v2 + MonthlyDistribution — spec-design-accounting-expansion.md
- JSON Schemas: Catalog entries for BudgetV2, MonthlyDistribution, WarehouseItem (with gtin?)

## References
- Backend files: `main/models.py`, `main/serializers.py`, `main/api_views.py`, `main/api_urls.py`, `main/admin.py`, `main/tests.py`
- Frontend files: `frontend/src/api.js`, `frontend/src/components/Warehouse.jsx` (or relevant form), `frontend/src/__tests__/...`
- Docs: `docs/API.md`, `spec/spec-design-master.md`
- Testing: Jest config, MSW handlers, Django tests in `main/tests.py`


## 9. Source: spec/spec-lineup-cannon-features-5.md

---
title: Converge Spec Line‑Up Plan — 5% Milestone
version: 0.1
date_created: 2025-10-11
last_updated: 2025-10-11
owner: Converge Product Team
tags: [plan, alignment, milestone, specs]
---

# Objective

Bring the running Converge codebase into alignment with the canonical master specification to a minimum of 5% functional/spec coverage, focusing on low‑risk, high‑signal updates that improve developer velocity and QA confidence.

Success at this milestone is measured by delivering the specific spec‑driven features below and passing the listed acceptance checks. This plan deliberately limits scope to stay under the 5% threshold and lay a strong foundation for subsequent 25%/50%/95% milestones.

## Alignment measurement (for this milestone)

Scope of “match” for 5% milestone is defined by these deliverables tied to the canonical spec:
- JSON Schema Catalog surfaced in master spec and discoverable to developers (ref: spec‑design‑master {#json-schema-catalog}).
- API consumer guidance for schema validation in docs (docs/API.md “Schema usage”).
- A dev‑only JSON Schema validation endpoint to quickly validate payloads against draft‑07 schemas (ref: API utilities, non‑production).

Collectively, these items constitute approximately 5% of the canonical spec surfaces (documentation + dev utilities) with minimal operational risk.

## Phase overview

- Phase 0 — Baseline and instrumentation (est. 0.5% contribution)
- Phase 1 — JSON Schema Catalog visibility (est. 2.0%)
- Phase 2 — API consumer guidance (docs/API.md) (est. 1.5%)
- Phase 3 — Dev JSON Schema validator endpoint (est. 1.0%)

Total estimated alignment: ~5.0%

Notes: Percentages are qualitative to illustrate scope; exact global match will be tracked more precisely at higher milestones by feature checklist and endpoint inventory.

---

## Phase 0 — Baseline and instrumentation (0.5%)

Goal: Ensure the codebase can reliably surface the canonical spec and pass structural checks so subsequent phases are traceable.

- Actions
  - Validate specs: run `tools/spec_validate.py` and resolve blocking errors if any.
  - Compile spec: run `tools/spec_compile.py` to refresh `spec/COMPILED_SPEC.md`.
  - Capture a short summary in the PR description (“Spec validation PASS; compiled N sources”).

- Deliverables
  - Passing validator output in CI logs.
  - Updated `spec/COMPILED_SPEC.md` artifact.

- Acceptance criteria
  - “Result: PASS” from validator.
  - Compiled spec exists and includes the master + module specs.

- Quality gates
  - Build/Lint/Test unchanged: PASS baseline required.

---

## Phase 1 — JSON Schema Catalog visibility (2.0%)

Goal: Make the canonical schemas easy to discover and reference directly from the master spec.

- Canonical references
  - Master spec → “JSON Schema Catalog” {#json-schema-catalog}
  - Draft‑07 as enforcement baseline; 2019‑09/2020‑12 as informational variants.

- Actions
  - Ensure `spec/spec-design-master.md` includes a JSON Schema Catalog listing links under `.copilot-tracking/research/` for:
    - Accounting: JournalEntry, Payment, Expense, MonthlyDistribution
    - FSM: ScheduledEvent, NotificationLog
    - Staff: Technician
    - Inventory & WOs: WarehouseItem, WorkOrder, WorkOrderInvoice

- Deliverables
  - Catalog section with file paths and brief alignment notes per schema.

- Acceptance criteria
  - Section present with draft‑07 links and notes; variants listed as informational.
  - Spec validator PASS; compiled spec contains the section.

- Quality gates
  - Docs lint (markdown) PASS; no CI regressions.

---

## Phase 2 — API consumer guidance in docs (1.5%)

Goal: Clarify how client teams should validate requests against draft‑07 and when to rely on server‑side validation.

- Canonical references
  - Master spec: API and Schema docs; JSON Schema posture (draft‑07 baseline).

- Actions
  - Update `docs/API.md` with a “Schema usage (JSON Schema)” section:
    - State draft‑07 as the baseline; variants are informational only.
    - Mention flexible fields (e.g., RRULE) validated server‑side.
    - Recommend Ajv (JS) and `jsonschema` (Python) with a tiny example.
    - Mention the dev validator endpoint for quick checks.

- Deliverables
  - Concise guidance section with one code example.

- Acceptance criteria
  - Docs PR includes the new section; linked to master spec catalog.
  - CI docs check PASS (if applicable).

- Quality gates
  - No code changes; lint/test unaffected.

---

## Phase 3 — Dev JSON Schema validator endpoint (1.0%)

Goal: Provide a fast, non‑production API for QA/devs to validate payloads against canonical schemas.

- Canonical references
  - Master spec: Utilities/Schema usage notes; dev tooling context.

- API contract (dev‑only)
  - POST `/api/dev/validate-json/`
  - Body: `{ "schema": "journalentry" | "scheduled-event" | ..., "payload": { ... } }`
  - Response: `{ schema, schema_path, valid: bool, errors: [{ path, message }] }`
  - Availability: Only when `DEBUG=True`; 404 otherwise.

- Actions
  - Implement view in `main/api_views.py` guarded by `settings.DEBUG`.
  - Wire URL in `main/api_urls.py` under `dev/validate-json/`.
  - Add `jsonschema` to `requirements.txt` for local dev.
  - Document the endpoint usage in `docs/API.md` (pointer already in Phase 2).

- Deliverables
  - Working endpoint in dev.
  - Example cURL in PR description; optional unit test (non‑blocking for 5%).

- Acceptance criteria
  - Valid payload returns `valid: true, errors: []`.
  - Invalid payload returns `valid: false` with readable JSON paths.
  - Endpoint is unreachable (404) when `DEBUG=False`.

- Quality gates
  - Backend tests PASS; lint PASS; no production surface exposed.

---

## Out of scope for 5% (queued for next milestones)

- GTIN utility: `/api/utils/gtin/check-digit/` and model‑level `WarehouseItem.gtin` validation.
- Budget v2 + MonthlyDistribution API and migrations.
- Posting rules hardening and GL line breakdowns.
- Technician assignment optimizer improvements and FSM UI wiring.

These items are planned for the 25% milestone to grow alignment in coherent vertical slices (Inventory + Accounting, FSM + Notifications).

---

## Risks and mitigations

- Risk: Schema drift between serializers and JSON Schemas.
  - Mitigation: Treat draft‑07 as authoritative; variants are annotations; use the dev validator for quick checks.
- Risk: Dev endpoint used outside of development.
  - Mitigation: Strict `DEBUG` guard; exclude from prod deployments.

---

## Handover checklist (per PR)

- Spec validator PASS; compiled spec updated.
- JSON Schema Catalog present in master spec.
- docs/API.md includes “Schema usage” with example.
- Dev validator endpoint callable and returns expected shapes.
- No production behavior changes; CI green.

---

## References

- Master Spec: `spec/spec-design-master.md` → API and Schema Documentation; JSON Schema Catalog {#json-schema-catalog}
- Research Schemas: `.copilot-tracking/research/*.schema.json`
- Tools: `tools/spec_validate.py`, `tools/spec_compile.py`



## 10. Source: spec/spec-process-lint-baseline-gating.md

---
title: Process Spec — ESLint Baseline Diff, Per-Rule Deltas, and Quality Gate
version: 1.0
date_created: 2025-10-10
last_updated: 2025-10-10
owner: Engineering
tags: [process, quality, lint, ci, javascript, powershell]
---

# Introduction

This specification defines the process, tooling, and quality gates for tracking ESLint status against legacy baselines, computing per-rule deltas, and enforcing non-regression in developer workflows and CI. It standardizes how lint debt is measured, reported, and gated to ensure continuous improvement without blocking daily work unnecessarily.

## 1. Purpose & Scope

- Purpose: Provide a deterministic, automated mechanism to compare current ESLint results to established baselines, surface per-rule changes, and fail builds on regressions beyond configured thresholds.
- Scope:
  - Frontend code under `frontend/src` (TypeScript/JavaScript/JSX/TSX).
  - Windows-first local execution (PowerShell 5.1) with cross-platform CI compatibility via Node/ESLint/npx.
  - Artifacts generated under `docs/reports/` for auditability.
- Audience: Frontend engineers, QA, DevOps/CI maintainers, team leads.
- Assumptions: Node and ESLint are installed via the frontend workspace; developers use VS Code tasks or PowerShell to run tools.

## 2. Definitions

- ESLint: JavaScript/TypeScript linter for static analysis of code quality and style.
- Baseline: A JSON file capturing the accepted legacy ESLint violations at a point in time (e.g., `frontend/lint-baseline.json`).
- Snapshot: A JSON file (`docs/reports/lint-snapshot.json`) recording the most recent run’s per-rule counts for delta computation over time.
- Per-rule Delta: The difference in count for a specific ESLint rule between the current run and the previous snapshot.
- Quality Gate: A policy that fails the execution (non-zero exit) when thresholds (total or per-rule) are exceeded.
- CI Parity: Running ESLint locally with the same configuration and scope as CI to ensure consistent results.

## 3. Requirements, Constraints & Guidelines

- REQ-001: The system shall produce a Markdown report at `docs/reports/lint-baseline-diff.md` comparing current ESLint results against one or more baselines.
- REQ-002: The system shall compute per-rule counts and write a snapshot to `docs/reports/lint-snapshot.json` for future delta comparisons.
- REQ-003: The system shall support thresholds `MaxTotalDelta` and `MaxRuleDelta` to enforce a quality gate by exiting with a non-zero code on regression.
- REQ-004: The system shall run on Windows PowerShell 5.1 without requiring policy changes beyond the documented task command.
- REQ-005: The system shall attempt robust ESLint resolution (npx on Windows, fallback to local `.bin`) and gracefully fail with actionable messaging if ESLint is unavailable.
- REQ-006: The system shall parse ESLint JSON output; if unavailable, it shall extract totals from text output as a fallback.
- REQ-007: The report shall include: current totals, baseline comparisons, per-rule top regressions/improvements, and gate result (PASS/FAIL) with reasons.
- REQ-008: The system shall not require network access; all analysis must be local.
- REQ-009: The system shall avoid non-ASCII symbols in PowerShell output strings (e.g., use "delta" instead of the Unicode Δ symbol).
- SEC-001: The tooling shall not collect or transmit source code or secrets; only lint summary data is stored in artifacts.
- CON-001: Analysis scope is limited to `frontend/src` matching extensions `.js,.jsx,.ts,.tsx` unless explicitly configured otherwise.
- GUD-001: Default thresholds should be strict (`0`) in gate tasks to prevent regressions; teams may relax for transitional phases.
- PAT-001: Prefer minimal, deterministic text output in CI; put human-readable detail in Markdown artifacts.

## 4. Interfaces & Data Contracts

4.1 VS Code Tasks

- lint: ci-parity
  - cwd: `frontend`
  - command: `npx eslint --max-warnings=0 --ext .js,.jsx,.ts,.tsx src`
  - outcome: Runs ESLint with local config; fails on any warnings/errors.

- lint: baseline-diff
  - command: `powershell -NoProfile -ExecutionPolicy Bypass -File "${workspaceFolder}\tools\lint_baseline_diff.ps1"`
  - outcome: Generates `docs/reports/lint-baseline-diff.md` and `docs/reports/lint-snapshot.json`; returns 0 regardless of deltas by default.

- lint: gate-baseline
  - command: `powershell -NoProfile -ExecutionPolicy Bypass -File "${workspaceFolder}\tools\lint_baseline_diff.ps1" -MaxTotalDelta 0 -MaxRuleDelta 0`
  - outcome: Same as baseline-diff but fails (non-zero) if total or any rule delta > 0.

4.2 Script Interface (PowerShell)

- Entrypoint: `tools/lint_baseline_diff.ps1`
- Parameters (examples):
  - `-SnapshotOut "docs/reports/lint-snapshot.json"` (optional; defaults to path in the script)
  - `-MaxTotalDelta 0` (optional; default may be relaxed for reporting-only runs)
  - `-MaxRuleDelta 0` (optional)
  - `-TopN 10` (optional; how many top regressions/improvements to show)

4.3 Snapshot JSON Schema (stable contract)

```json
{
  "timestamp": "YYYY-MM-DDTHH:MM:SS",
  "totalProblems": 0,
  "errors": 0,
  "warnings": 0,
  "ruleCounts": {
    "rule-name-1": 123,
    "rule-name-2": 4
  }
}
```

4.4 Markdown Report Structure (machine-readable anchors)

- Title: "ESLint Baseline Diff"
- Sections (in this order):
  1. Current Totals
  2. Baseline Comparisons (vs each known baseline)
  3. Per-Rule Changes
     - Top Regressions (N)
     - Top Improvements (N)
  4. Quality Gate Result
  5. Invocation Parameters (echo)

## 5. Acceptance Criteria

- AC-001: Given no changes vs baseline, when `lint: gate-baseline` runs, then exit code is 0 and report marks status as "NO CHANGE".
- AC-002: Given one new ESLint violation, when `lint: gate-baseline` runs with `MaxTotalDelta 0`, then exit code is non-zero and report includes a "REGRESSED" status and lists the rule in Top Regressions.
- AC-003: Given improvements (negative deltas) and no regressions, when `lint: gate-baseline` runs, then exit code is 0 and the report highlights improvements with negative deltas.
- AC-004: Given ESLint is not installed, when any lint task runs, then a clear error message is emitted explaining how to install or run from `frontend/`, and exit code is non-zero.
- AC-005: Given ESLint JSON output is unavailable, when the script runs, then totals are derived from text output and a report is still generated.

## 6. Test Automation Strategy

- Test Levels: Script-level integration tests; lightweight unit tests for helper functions (optional).
- Frameworks: Pester 5 for PowerShell script tests; Jest for verifying ESLint configuration integrity (optional).
- Test Data Management: Use a small fixture project (subset of `frontend/src`) to generate deterministic lint outputs for CI tests.
- CI/CD Integration: Add a CI job that runs `lint: ci-parity` (fail-fast) and `lint: gate-baseline` (artifact + gate). Store `docs/reports/lint-baseline-diff.md` and `lint-snapshot.json` as build artifacts.
- Coverage Requirements: Not applicable for scripts; ensure Pester asserts cover success, regression, fallback parsing, and missing-ESLint cases.
- Performance Testing: Ensure script completes within 2 minutes on typical developer machines for the full `frontend/src`.

## 7. Rationale & Context

Lint baselines enable teams to adopt stricter rules without blocking progress. However, without automated gates, debt can silently grow. This spec defines a measured approach: report deltas, preserve visibility with artifacts, and enforce non-regression through configurable thresholds. Per-rule deltas add precision by identifying which rules trend in the wrong direction.

## 8. Dependencies & External Integrations

### External Systems
- EXT-001: None.

### Third-Party Services
- SVC-001: None.

### Infrastructure Dependencies
- INF-001: Node.js + npm available in the developer environment and CI agents.

### Data Dependencies
- DAT-001: Baseline files: `frontend/lint-baseline.json`, `frontend/lint-baseline-batch3.json`.
- DAT-002: Snapshot artifact path: `docs/reports/lint-snapshot.json`.

### Technology Platform Dependencies
- PLT-001: PowerShell 5.1 on Windows for local execution.
- PLT-002: ESLint, executed via `npx` with repo-local configuration `frontend/eslint.config.js`.

### Compliance Dependencies
- COM-001: None.

## 9. Examples & Edge Cases

```powershell
# Reporting only (no gate), default snapshot path
powershell -NoProfile -ExecutionPolicy Bypass -File \
  .\tools\lint_baseline_diff.ps1

# Strict gate: fail on any regression in totals or per-rule
powershell -NoProfile -ExecutionPolicy Bypass -File \
  .\tools\lint_baseline_diff.ps1 -MaxTotalDelta 0 -MaxRuleDelta 0

# Custom snapshot output and top-5 summaries
powershell -NoProfile -ExecutionPolicy Bypass -File \
  .\tools\lint_baseline_diff.ps1 -SnapshotOut .\docs\reports\lint-snapshot.json -TopN 5
```

Edge cases:
- ESLint not found (npx missing): emit guidance and exit non-zero.
- ESLint JSON output formatting changes: fallback text parsing yields totals; per-rule deltas are omitted with a warning.
- Unicode in console output: use ASCII-safe strings (e.g., "delta") to avoid PowerShell formatting errors.

## 10. Validation Criteria

- The tasks `lint: ci-parity`, `lint: baseline-diff`, and `lint: gate-baseline` are present and runnable in VS Code.
- Running `lint: baseline-diff` creates both `docs/reports/lint-baseline-diff.md` and `docs/reports/lint-snapshot.json`.
- Running `lint: gate-baseline` fails with non-zero exit on any regression with thresholds set to 0.
- Reports consistently show per-rule top regressions/improvements when ESLint JSON is available.
- On machines without ESLint, the task fails fast with a clear remediation message.

## 11. Related Specifications / Further Reading

- docs/reports/scripts/README.md — Lint scripts documentation and workflows
- docs/DEVELOPMENT.md — Development workflow and quality gates
- docs/reports/LINT_REDUCTION_ROADMAP.md — Progressive plan to reduce lint debt



## 11. Source: spec/spec-process-lint-baseline-gating[processed].md

---
title: [Processed] ESLint Baseline Diff and Gates
version: 1.0
date_processed: 2025-10-10
owner: Engineering
tags: [processed, lint, baseline, gates]
---

This process spec has been consolidated into the master design specification under:

- Section: "Process Quality: ESLint Baseline Diffs and Gates" (#process-eslint-baseline) in `spec/spec-design-master.md`.
- Interfaces: VS Code tasks and PowerShell entrypoints are captured there.

Original document retained only as a processed marker.



## 12. Source: spec/tasks.md

# Implementation Tasks

1. Authentication API: implement login/logout endpoints and user retrieval
2. RBAC enforcement: filter querysets based on user role
3. Deal-to-Project automation via signals
4. Invoice reminder email automation
5. Frontend integration for Account, Contact, Deal CRUD
6. Testing: backend DRF tests and frontend RTL tests
